<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent 网络拓扑图</title>
    
    <style>
        /* 基础样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #1e1e2f;
            color: #e4e6eb;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* 标题区域 */
        header {
            padding: 20px;
            background-color: #24243e;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        /* 主要内容区域 */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .topology-section {
            flex: 1 1 65%;
            min-width: 600px;
        }
        
        .controls-section {
            flex: 1 1 30%;
            min-width: 300px;
        }
        
        /* 卡片样式 */
        .card {
            background-color: #24243e;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-header {
            padding: 15px;
            background-color: #2a2a45;
            border-bottom: 1px solid #36365a;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        
        .card-header h2::before {
            content: '#';
            color: #7b68ee;
            margin-right: 10px;
            font-size: 22px;
        }
        
        .card-body {
            padding: 15px;
        }
        
        /* 拓扑图容器 */
        .topology-container {
            width: 100%;
            height: 500px;
            background-color: #1a1a30;
            border: 1px solid #36365a;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
        }
        
        /* 工具栏 */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .btn {
            padding: 5px 12px;
            background-color: #36365a;
            border: 1px solid #44446e;
            color: #e4e6eb;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #44446e;
        }
        
        .btn-primary {
            background-color: #7b68ee;
            border-color: #7b68ee;
        }
        
        .btn-primary:hover {
            background-color: #6a58d9;
        }
        
        .btn.active {
            background-color: #7b68ee;
            color: white;
        }
        
        /* 设备网格 */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .device-item {
            padding: 10px;
            background-color: #2a2a45;
            border: 1px solid #36365a;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .device-item:hover {
            background-color: #36365a;
        }
        
        .device-icon {
            width: 30px;
            height: 30px;
            background-color: #1a1a30;
            margin: 0 auto 5px;
            border-radius: 5px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* 属性面板 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #a8aabc;
        }
        
        .form-control {
            width: 100%;
            padding: 8px;
            background-color: #1a1a30;
            border: 1px solid #36365a;
            border-radius: 4px;
            color: #e4e6eb;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #7b68ee;
        }
        
        /* 日志面板 */
        .log-panel {
            height: 300px;
            overflow-y: auto;
            background-color: #1a1a30;
            border: 1px solid #36365a;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid #2a2a45;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        /* 加载动画 */
        .canvas-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(30, 30, 47, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(123, 104, 238, 0.3);
            border-radius: 50%;
            border-top-color: #7b68ee;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 状态栏 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            background-color: #24243e;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: #a8aabc;
            margin-top: 10px;
        }
    </style>
    
    <!-- 尝试从CDN加载Fabric.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <!-- 备用本地加载 -->
    <script>
        if (typeof fabric === 'undefined') {
            console.log('从CDN加载Fabric.js失败，尝试从本地加载');
            document.write('<script src="./node_modules/fabric/dist/index.min.js"><\/script>');
        } else {
            console.log('从CDN成功加载Fabric.js');
        }
    </script>
    
    <!-- 调试Fabric.js加载情况 -->
    <script>
        console.log('在HTML中直接检查Fabric.js: ', typeof fabric);
        console.log('Fabric.Canvas是否存在: ', typeof fabric === 'object' && typeof fabric.Canvas === 'function');
    </script>
    
    <!-- 再加载我们的优化版拓扑图库 -->
    <script src="./optimized-topology.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>企业内网渗透场景 - AI Agent 驱动的动态攻防推演靶场</h1>
        </header>
        
        <div class="main-content">
            <!-- 左侧拓扑图区域 -->
            <div class="topology-section">
                <div class="card">
                    <div class="card-header">
                        <h2>交互式网络拓扑图</h2>
                    </div>
                    <div class="card-body">
                        <!-- 工具栏 -->
                        <div class="toolbar">
                            <button id="select-mode" class="btn mode-button active">选择</button>
                            <button id="connect-mode" class="btn mode-button">连接</button>
                            <button id="pan-mode" class="btn mode-button">平移</button>
                            <button id="delete-selected" class="btn">删除</button>
                            <div style="flex-grow: 1;"></div>
                            <button id="zoom-in" class="btn">放大</button>
                            <button id="zoom-out" class="btn">缩小</button>
                            <button id="zoom-reset" class="btn">重置</button>
                            <button id="create-sample" class="btn btn-primary">创建示例</button>
                        </div>
                        
                        <!-- 拓扑图容器 -->
                        <div class="topology-container">
                            <!-- 加载动画 -->
                            <div class="canvas-loading" id="topology-loading">
                                <div class="loading-spinner"></div>
                            </div>
                            
                            <canvas id="network-topology"></canvas>
                        </div>
                        
                        <!-- 状态栏 -->
                        <div class="status-bar">
                            <div id="cursor-position">位置: 0, 0</div>
                            <div id="zoom-level">缩放: 100%</div>
                            <div id="mode-status">模式: 选择</div>
                            <div id="selection-info">已选择: 无</div>
                        </div>
                    </div>
                </div>
                
                <!-- 场景描述 -->
                <div class="card">
                    <div class="card-header">
                        <h2>场景描述</h2>
                    </div>
                    <div class="card-body">
                        <p>在这个企业网络环境中，您将扮演渗透测试工程师，评估企业内网安全。该企业采用多层防御架构，包括DMZ区域、办公网络和核心业务区。您的任务是从边缘服务器开始，通过横向移动技术提升权限，最终获取核心业务系统的控制权。</p>
                        <p>该场景包含多种网络设备、服务器和应用程序，需要识别配置错误、漏洞利用以及权限提升技术。网络环境中部署了防火墙、IDS/IPS和EDR等安全产品。</p>
                    </div>
                </div>
            </div>
            
            <!-- 右侧控制面板 -->
            <div class="controls-section">
                <!-- 设备库 -->
                <div class="card">
                    <div class="card-header">
                        <h2>设备库</h2>
                    </div>
                    <div class="card-body">
                        <div class="device-grid">
                            <div class="device-item" data-device="router">
                                <div class="device-icon" style="background-color: #4CAF5033">
                                    <span style="color: #4CAF50">◆</span>
                                </div>
                                <div>路由器</div>
                            </div>
                            <div class="device-item" data-device="firewall">
                                <div class="device-icon" style="background-color: #F4433633">
                                    <span style="color: #F44336">◆</span>
                                </div>
                                <div>防火墙</div>
                            </div>
                            <div class="device-item" data-device="switch">
                                <div class="device-icon" style="background-color: #2196F333">
                                    <span style="color: #2196F3">◆</span>
                                </div>
                                <div>交换机</div>
                            </div>
                            <div class="device-item" data-device="server">
                                <div class="device-icon" style="background-color: #FF980033">
                                    <span style="color: #FF9800">◆</span>
                                </div>
                                <div>服务器</div>
                            </div>
                            <div class="device-item" data-device="pc">
                                <div class="device-icon" style="background-color: #9C27B033">
                                    <span style="color: #9C27B0">◆</span>
                                </div>
                                <div>工作站</div>
                            </div>
                            <div class="device-item" data-device="ids">
                                <div class="device-icon" style="background-color: #673AB733">
                                    <span style="color: #673AB7">◆</span>
                                </div>
                                <div>IDS</div>
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #a8aabc; text-align: center;">
                            点击设备添加到拓扑图
                        </div>
                    </div>
                </div>
                
                <!-- 属性面板 -->
                <div class="card">
                    <div class="card-header">
                        <h2>属性面板</h2>
                    </div>
                    <div class="card-body">
                        <!-- 未选择任何对象时显示 -->
                        <div id="no-selection" class="text-center" style="text-align: center; padding: 20px; color: #a8aabc;">
                            <div style="margin-bottom: 10px;">↖</div>
                            <p>请选择设备或连接</p>
                        </div>
                        
                        <!-- 设备属性 -->
                        <div id="device-properties" style="display:none;">
                            <div class="form-group">
                                <label for="device-name">设备名称</label>
                                <input type="text" id="device-name" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="device-ip">IP地址</label>
                                <input type="text" id="device-ip" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="device-mac">MAC地址</label>
                                <input type="text" id="device-mac" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="device-description">描述</label>
                                <textarea id="device-description" class="form-control" rows="2"></textarea>
                            </div>
                            <button id="apply-device" class="btn btn-primary" style="width: 100%;">应用更改</button>
                        </div>
                        
                        <!-- 连接属性 -->
                        <div id="connection-properties" style="display:none;">
                            <div class="form-group">
                                <label for="connection-type">连接类型</label>
                                <select id="connection-type" class="form-control">
                                    <option value="ethernet">以太网</option>
                                    <option value="fiber">光纤</option>
                                    <option value="wireless">无线</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="connection-bandwidth">带宽</label>
                                <select id="connection-bandwidth" class="form-control">
                                    <option value="10mbps">10 Mbps</option>
                                    <option value="100mbps">100 Mbps</option>
                                    <option value="1gbps">1 Gbps</option>
                                    <option value="10gbps">10 Gbps</option>
                                </select>
                            </div>
                            <button id="apply-connection" class="btn btn-primary" style="width: 100%;">应用更改</button>
                        </div>
                    </div>
                </div>
                
                <!-- 操作日志面板 -->
                <div class="card">
                    <div class="card-header">
                        <h2>操作日志</h2>
                    </div>
                    <div class="card-body">
                        <div id="log-entries" class="log-panel">
                            <!-- 日志条目将由JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            // 日志记录函数
            function addLogEntry(message, type = 'info') {
                const logPanel = document.getElementById('log-entries');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                const time = new Date().toLocaleTimeString();
                const color = 
                    type === 'error' ? '#F44336' : 
                    type === 'success' ? '#4CAF50' : 
                    type === 'warning' ? '#FF9800' : '#2196F3';
                
                entry.innerHTML = `<span style="color: #888;">[${time}]</span> <span style="color: ${color};">${message}</span>`;
                logPanel.appendChild(entry);
                logPanel.scrollTop = logPanel.scrollHeight;
                
                // 同时输出到控制台
                console[type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log'](message);
            }
            
            // 显示错误消息
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.position = 'fixed';
                errorDiv.style.top = '20px';
                errorDiv.style.left = '50%';
                errorDiv.style.transform = 'translateX(-50%)';
                errorDiv.style.backgroundColor = '#F44336';
                errorDiv.style.color = 'white';
                errorDiv.style.padding = '15px 20px';
                errorDiv.style.borderRadius = '4px';
                errorDiv.style.zIndex = '9999';
                errorDiv.textContent = message;
                
                // 添加关闭按钮
                const closeBtn = document.createElement('span');
                closeBtn.textContent = ' × ';
                closeBtn.style.marginLeft = '15px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.fontWeight = 'bold';
                closeBtn.onclick = function() {
                    document.body.removeChild(errorDiv);
                };
                
                errorDiv.appendChild(closeBtn);
                document.body.appendChild(errorDiv);
                
                // 添加到日志
                addLogEntry(message, 'error');
            }
            
            // 初始化
            try {
                // 检查Fabric.js是否加载成功
                if (typeof fabric === 'undefined') {
                    throw new Error('Fabric.js未能正确加载，请检查您的网络连接或引用路径');
                }
                
                // 检查NetworkTopology是否加载成功
                if (typeof NetworkTopology === 'undefined') {
                    throw new Error('NetworkTopology模块未能正确加载，请检查文件路径');
                }
                
                // 在Fabric.js 6.x中，版本属性可能有变化
                addLogEntry(`Fabric.js已加载成功`, 'success');
                
                // 获取Canvas大小
                const container = document.querySelector('.topology-container');
                const width = container.clientWidth || 800;
                const height = container.clientHeight || 500;
                
                // 创建网络拓扑图实例
                const topology = new NetworkTopology({
                    canvasId: 'network-topology',
                    width: width,
                    height: height,
                    backgroundColor: 'rgba(30, 30, 47, 0.5)'
                });
                
                // 初始化拓扑图
                topology.initialize()
                    .then(() => {
                        addLogEntry('网络拓扑图初始化成功', 'success');
                        setupUI(topology);
                    })
                    .catch(error => {
                        showError(`初始化失败: ${error.message}`);
                    });
                
                // 设置UI事件和交互
                function setupUI(topology) {
                    // 模式按钮
                    const modeButtons = document.querySelectorAll('.mode-button');
                    modeButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            // 移除所有模式按钮的active类
                            modeButtons.forEach(btn => btn.classList.remove('active'));
                            // 当前按钮添加active类
                            this.classList.add('active');
                            
                            // 设置模式
                            const mode = this.id.replace('-mode', '');
                            topology.setMode(mode);
                            
                            // 更新模式状态显示
                            const modeText = mode === 'select' ? '选择' : mode === 'connect' ? '连接' : '平移';
                            document.getElementById('mode-status').textContent = `模式: ${modeText}`;
                        });
                    });
                    
                    // 删除按钮
                    document.getElementById('delete-selected').addEventListener('click', () => {
                        if (topology.deleteSelected()) {
                            addLogEntry('已删除选中的对象', 'success');
                        } else {
                            addLogEntry('没有选中任何对象', 'warning');
                        }
                    });
                    
                    // 缩放按钮
                    document.getElementById('zoom-in').addEventListener('click', () => {
                        const zoom = topology.zoomIn();
                        document.getElementById('zoom-level').textContent = `缩放: ${Math.round(zoom * 100)}%`;
                    });
                    
                    document.getElementById('zoom-out').addEventListener('click', () => {
                        const zoom = topology.zoomOut();
                        document.getElementById('zoom-level').textContent = `缩放: ${Math.round(zoom * 100)}%`;
                    });
                    
                    document.getElementById('zoom-reset').addEventListener('click', () => {
                        topology.resetView();
                        document.getElementById('zoom-level').textContent = '缩放: 100%';
                    });
                    
                    // 创建示例拓扑图
                    document.getElementById('create-sample').addEventListener('click', () => {
                        topology.createSampleTopology();
                        addLogEntry('已创建示例拓扑图', 'success');
                    });
                    
                    // 设备库项点击事件
                    document.querySelectorAll('.device-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const deviceType = this.getAttribute('data-device');
                            const device = topology.createDevice(deviceType);
                            addLogEntry(`已添加新的${getDeviceTypeName(deviceType)}`, 'success');
                        });
                    });
                    
                    // 设置属性面板
                    topology.on('selectionChanged', (data) => {
                        const obj = data.object;
                        
                        // 隐藏所有属性面板
                        document.getElementById('no-selection').style.display = 'block';
                        document.getElementById('device-properties').style.display = 'none';
                        document.getElementById('connection-properties').style.display = 'none';
                        
                        // 更新选择信息
                        document.getElementById('selection-info').textContent = '已选择: 无';
                        
                        if (!obj) return;
                        
                        // 显示相应属性面板
                        if (obj.type === 'device') {
                            document.getElementById('no-selection').style.display = 'none';
                            document.getElementById('device-properties').style.display = 'block';
                            
                            // 填充设备属性
                            document.getElementById('device-name').value = obj.deviceData.name || '';
                            document.getElementById('device-ip').value = obj.deviceData.ip || '';
                            document.getElementById('device-mac').value = obj.deviceData.mac || '';
                            document.getElementById('device-description').value = obj.deviceData.description || '';
                            
                            // 更新选择信息
                            document.getElementById('selection-info').textContent = `已选择: ${obj.deviceData.name}`;
                            
                            // 应用设备属性修改
                            document.getElementById('apply-device').onclick = function() {
                                obj.deviceData.name = document.getElementById('device-name').value;
                                obj.deviceData.ip = document.getElementById('device-ip').value;
                                obj.deviceData.mac = document.getElementById('device-mac').value;
                                obj.deviceData.description = document.getElementById('device-description').value;
                                
                                // 更新标签
                                if (obj.label) {
                                    obj.label.set({ text: obj.deviceData.name });
                                    topology.canvas.renderAll();
                                }
                                
                                addLogEntry(`已更新设备 ${obj.deviceData.name} 的属性`, 'success');
                            };
                        } else if (obj.type === 'connection') {
                            document.getElementById('no-selection').style.display = 'none';
                            document.getElementById('connection-properties').style.display = 'block';
                            
                            // 填充连接属性
                            document.getElementById('connection-type').value = obj.connectionType || 'ethernet';
                            
                            // 更新选择信息
                            const sourceName = obj.source && obj.source.deviceData ? obj.source.deviceData.name : '未知';
                            const targetName = obj.target && obj.target.deviceData ? obj.target.deviceData.name : '未知';
                            document.getElementById('selection-info').textContent = `已选择: ${sourceName} 到 ${targetName} 的连接`;
                            
                            // 应用连接属性修改
                            document.getElementById('apply-connection').onclick = function() {
                                const type = document.getElementById('connection-type').value;
                                const connType = topology.connectionTypes[type];
                                
                                obj.set({
                                    stroke: connType.color,
                                    strokeWidth: connType.width,
                                    strokeDashArray: connType.dash,
                                    connectionType: type
                                });
                                
                                topology.canvas.renderAll();
                                addLogEntry(`已更新连接属性`, 'success');
                            };
                        }
                    });
                    
                    // 拓扑图事件处理
                    topology.on('deviceCreated', (data) => {
                        console.log('设备已创建:', data.device);
                    });
                    
                    topology.on('connectionCreated', (data) => {
                        console.log('连接已创建:', data.connection);
                    });
                    
                    topology.on('zoom', (data) => {
                        document.getElementById('zoom-level').textContent = `缩放: ${Math.round(data.level * 100)}%`;
                    });
                    
                    // 页面大小改变时重新调整Canvas
                    window.addEventListener('resize', () => {
                        const container = document.querySelector('.topology-container');
                        if (container && topology.canvas) {
                            const width = container.clientWidth;
                            const height = container.clientHeight;
                            
                            topology.canvas.setWidth(width);
                            topology.canvas.setHeight(height);
                            topology.canvas.renderAll();
                        }
                    });
                }
                
                // 获取设备类型的中文名称
                function getDeviceTypeName(type) {
                    const names = {
                        'router': '路由器',
                        'firewall': '防火墙',
                        'switch': '交换机',
                        'server': '服务器',
                        'pc': '工作站',
                        'ids': 'IDS'
                    };
                    return names[type] || type;
                }
                
            } catch (error) {
                console.error('初始化过程中出现错误:', error);
                showError('初始化过程中出现错误: ' + error.message);
            }
        });
    </script>
</body>
</html> 