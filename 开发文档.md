

目录
一、 引言	1
二、 系统开发环境	1
2.1 硬件要求	1
2.2 软件环境	1
2.3 开发依赖	1
三、 开发说明	2
3.1代码结构说明	2
3.2核心模块开发说明	2
3.2.1场景生成模块	2
3.2.2攻击Agent模块	2
3.2.3防御Agent模块	2
3.2.4演练评估模块	2
四、 接口设计	2
五、 数据库设计	2
六、 核心算法	2
6.1 攻防决策算法流程	2
6.2 强化学习策略说明	2
6.3 场景生成模型调用方式	2
七、 异常处理与日志规范	3
7.1 异常代码说明	3
7.2 日志记录规范	3
八、 安全与权限控制	3
8.1 Agent安全隔离设计	3
8.2 API权限认证	3


一、引言
随着网络攻防对抗的智能化趋势不断加深，传统开发模式在构建高仿真、动态化的攻防演练平台方面已难以满足需求。为应对网络安全演练过程中场景静态化、策略单一化、评估主观化等痛点，我们研发了“AI-Force 靶场推演智枢”平台，采用生成式AI、强化学习、多智能体协同等前沿技术，实现场景自动生成、攻击防御策略自适应优化与量化评估全流程自动化。
本开发文档旨在为平台的开发者和维护人员提供系统架构、核心模块设计、算法实现细节、接口规范、数据库结构、异常处理机制及安全策略等技术说明，确保开发过程的规范性与可扩展性，并为后续功能迭代提供技术支撑。
该文档适用于平台研发团队、技术支持人员以及后续参与二次开发的工程师，尤其是需要深入理解多Agent协作机制、动态场景生成技术及智能决策算法的开发者。通过本开发文档，读者可以全面掌握平台的代码结构、模块职责、接口调用方式以及核心算法逻辑，确保系统具备高可靠性、可维护性和安全性，从而支撑网络攻防实训、教学、科研及竞赛的多场景应用。










二、系统开发环境
2.1硬件要求
为确保本平台在不同环境下稳定运行，建议配置如下表：
表2-1 开发环境硬件要求表
配置项	最低要求	推荐要求
CPU	Intel Core i5 /
AMD Ryzen 5	Intel Core i7/ 
AMD Ryzen 7
内存	16 GB DDR4	32 GB DDR4
存储	256 GB SSD	512 GB NVMe SSD
网络	千兆以太网	千兆以太网
显卡（可选）	集成显卡即可	NVIDIA GTX 1660 Ti
表2-2 生产部署硬件要求表
配置项	基础部署	高并发部署
CPU	4 核 / 8 线程	8 核 / 16 线程
内存	16 GB	32 GB
存储	512 GB SSD	1 TB NVMe SSD
网络	千兆以太网	千兆以太网
配置项	基础部署	高并发部署
特殊要求：
(1)虚拟化支持：需开启 Intel VT-x 或 AMD-V
(2)Docker 支持：必须安装 Docker 引擎，支持容器运行
(3)端口资源：需预留 8000-8010、8080、5173 等端口用于服务通信
2.2软件环境
本项目开发和运行依赖以下软件环境：
1.操作系统：
Windows：Windows 10/11 (64位)
Linux：Ubuntu 20.04+ 
macOS：macOS 12+ 
2.基础运行环境：
2-3 基础运行环境表
组件	版本要求
Python	3.8+ 
Node.js	16+ 
npm 	8+ 
Docker	Docker Desktop 4.0+，Engine 20.10+
Docker Compose	2.0+
Git	2.30+
3.开发工具
本项目在开发过程中使用以下工具与辅助软件，覆盖代码编写、版本控制、调试测试、容器管理等关键环节：
(1)集成开发环境：本项目使用VS Code,支持 Python 语法高亮、远程调试与 Docker 集成的IDE，便于复杂项目结构管理,安装Python、Docker、REST Client、GitLens等插件。
(2)版本控制与协作：使用Git + GitHub 用于版本控制与团队协作，支持分支管理、代码审查等功能。
(3)容器与环境管理:本项目采用Docker作为封装开发环境与部署环境，保证系统隔离性与可移植性，各类组件如攻击Agent、防御Agent、靶场服务均基于Docker容器运行;Docker Compose支持编排多个容器，便于一键部署多模块系统。
(4)接口测试工具：采用Postman作为测试平台提供的API接口。支持设置请求头、请求体、认证信息等，可配合自动化测试脚本。入docker-compose.yml文件以实现自动化构建。
(5)日志与调试工具：本项目使用 Loguru 等高级日志库，对运行过程中的关键操作、异常信息进行日志记录，便于后续调试与问题追踪。
2.3开发依赖
   本项目主要基于前后端分离架构进行开发，后端采用 Python 生态，前端采用 Vue 框架。各部分开发依赖如下所示：

### 2.3.1 后端核心依赖

#### (1) Web框架与API服务
- **FastAPI** (v0.104.1+): 现代化Python Web框架，支持自动API文档生成、类型检查和异步处理
- **Uvicorn** (v0.24.0+): ASGI服务器，用于运行FastAPI应用
- **Pydantic** (v2.5.0+): 数据验证和序列化库，与FastAPI深度集成
- **Starlette** (v0.27.0+): FastAPI底层ASGI框架

#### (2) AI Agent框架
- **LangChain** (v0.1.0+): 大语言模型应用开发框架，支持链式调用和工具集成
- **LangGraph** (v0.0.40+): 多智能体协作框架，支持状态图和工作流编排
- **LangChain-Community** (v0.0.20+): LangChain社区扩展包
- **fastmcp** (v0.1.0+): Model Context Protocol服务通信框架，支持工具调用和服务间通信

#### (3) 大语言模型接口
- **langchain-deepseek** (v0.1.0+): DeepSeek API集成库
- **openai** (v1.6.0+): OpenAI API客户端库（备用）
- **httpx** (v0.25.0+): 异步HTTP客户端，用于API调用
- **requests** (v2.31.0+): 同步HTTP客户端库

#### (4) 强化学习框架
- **stable-baselines3** (v2.2.1+): 强化学习算法库，支持PPO、A2C、DQN等算法
- **gymnasium** (v0.29.0+): 强化学习环境接口标准
- **torch** (v2.1.0+): PyTorch深度学习框架
- **numpy** (v1.24.0+): 数值计算库

#### (5) 容器化与部署
- **Docker** (v20.10+): 容器化平台
- **docker-compose** (v2.0+): 多容器编排工具
- **docker-py** (v6.1.0+): Docker Python SDK，用于容器管理
- **kubernetes** (v28.1.0+): Kubernetes Python客户端

#### (6) 数据库与存储
- **SQLAlchemy** (v2.0.0+): Python SQL工具包和ORM
- **alembic** (v1.13.0+): 数据库迁移工具
- **asyncpg** (v0.29.0+): PostgreSQL异步驱动
- **redis** (v5.0.0+): Redis客户端库
- **chromadb** (v0.4.0+): 向量数据库，用于存储MITRE ATT&CK知识库

#### (7) 数据处理与分析
- **pandas** (v2.1.0+): 数据分析和处理库
- **numpy** (v1.24.0+): 数值计算库
- **scipy** (v1.11.0+): 科学计算库
- **scikit-learn** (v1.3.0+): 机器学习库

#### (8) 可视化与报告
- **matplotlib** (v3.8.0+): 基础绘图库
- **plotly** (v5.17.0+): 交互式图表库
- **seaborn** (v0.13.0+): 统计数据可视化
- **reportlab** (v4.0.0+): PDF报告生成库
- **jinja2** (v3.1.0+): 模板引擎，用于动态生成报告

#### (9) 安全工具集成
- **python-nmap** (v0.7.1+): Nmap网络扫描工具Python接口
- **paramiko** (v3.3.0+): SSH客户端库
- **scapy** (v2.5.0+): 网络包处理库
- **cryptography** (v41.0.0+): 加密算法库
- **pymetasploit3** (v1.0.3+): Metasploit框架Python接口

#### (10) 配置与日志
- **python-dotenv** (v1.0.0+): 环境变量管理
- **pyyaml** (v6.0.1+): YAML配置文件解析
- **loguru** (v0.7.0+): 现代化日志库
- **structlog** (v23.2.0+): 结构化日志库

#### (11) 测试框架
- **pytest** (v7.4.0+): Python测试框架
- **pytest-asyncio** (v0.21.0+): 异步测试支持
- **httpx** (v0.25.0+): 异步HTTP测试客户端
- **factory-boy** (v3.3.0+): 测试数据工厂

### 2.3.2 前端核心依赖

#### (1) 核心框架
- **Vue.js** (v3.3.0+): 渐进式JavaScript框架
- **Vite** (v4.5.0+): 现代化前端构建工具
- **TypeScript** (v5.2.0+): JavaScript超集，提供类型检查

#### (2) 路由与状态管理
- **Vue Router** (v4.2.0+): Vue.js官方路由管理器
- **Pinia** (v2.1.0+): Vue.js状态管理库
- **VueUse** (v10.5.0+): Vue.js组合式API工具集

#### (3) UI组件库
- **TailwindCSS** (v3.3.0+): 原子化CSS框架
- **DaisyUI** (v3.9.0+): TailwindCSS组件库
- **Headless UI** (v1.7.0+): 无样式UI组件库
- **Heroicons** (v2.0.0+): SVG图标库

#### (4) 网络请求与通信
- **Axios** (v1.6.0+): HTTP客户端库
- **Socket.io-client** (v4.7.0+): WebSocket客户端
- **sse.js** (v2.0.0+): Server-Sent Events客户端

#### (5) 数据可视化
- **ECharts** (v5.4.0+): 百度开源图表库
- **D3.js** (v7.8.0+): 数据驱动的文档操作库
- **Fabric.js** (v5.3.0+): 2D画布库，用于拓扑图绘制
- **Cytoscape.js** (v3.26.0+): 图论分析和可视化库

#### (6) 工具库
- **Lodash** (v4.17.0+): JavaScript实用工具库
- **Day.js** (v1.11.0+): 轻量级日期处理库
- **UUID** (v9.0.0+): UUID生成库
- **File-saver** (v2.0.0+): 文件下载库

#### (7) 开发工具
- **ESLint** (v8.52.0+): JavaScript代码检查工具
- **Prettier** (v3.0.0+): 代码格式化工具
- **Husky** (v8.0.0+): Git钩子工具
- **lint-staged** (v15.0.0+): 暂存文件检查工具

### 2.3.3 开发环境工具

#### (1) 版本控制
- **Git** (v2.30+): 分布式版本控制系统
- **GitHub**: 代码托管平台，支持CI/CD集成

#### (2) 容器化开发
- **Docker Desktop** (v4.0+): 容器化开发环境
- **Docker Compose** (v2.0+): 多容器应用编排
- **Kubernetes** (v1.24+): 容器编排平台

#### (3) 代码编辑器
- **Visual Studio Code**: 主要开发IDE
  - Python扩展包
  - Vue Language Features (Volar)
  - Docker扩展
  - GitLens扩展
  - REST Client扩展

#### (4) API测试工具
- **Postman** (v10.0+): API接口测试工具
- **Insomnia** (v2023.5+): REST API客户端
- **curl**: 命令行HTTP客户端

#### (5) 数据库管理
- **pgAdmin** (v7.0+): PostgreSQL管理工具
- **Redis Commander**: Redis可视化管理工具
- **DBeaver** (v23.0+): 通用数据库管理工具

### 2.3.4 第三方组件与开源框架详细说明

本平台集成了多个成熟的开源框架和第三方组件，以下是详细的技术选型说明：

#### (1) 核心AI框架
**LangChain生态系统**
- **用途**: 构建AI Agent应用的核心框架
- **版本**: v0.1.0+
- **许可证**: MIT License
- **官网**: https://langchain.com
- **集成方式**: `pip install langchain langchain-community`
- **关键特性**:
  - 支持多种LLM模型接入(OpenAI、DeepSeek、Claude等)
  - 提供工具调用和链式处理能力
  - 内置记忆和状态管理
  - 支持异步处理和流式输出
- **在项目中的应用**:
  - 场景智能体的提示词处理
  - 攻击智能体的决策链
  - 评估智能体的分析逻辑

**LangGraph多智能体框架**
- **用途**: 实现多智能体协作和工作流编排
- **版本**: v0.0.40+
- **许可证**: MIT License
- **集成方式**: `pip install langgraph`
- **关键特性**:
  - 状态图驱动的Agent协作
  - 支持条件分支和循环
  - 内置检查点和回滚机制
  - 可视化工作流调试
- **在项目中的应用**:
  - 攻防演练流程编排
  - 智能体间消息传递
  - 复杂决策流程管理

#### (2) Web框架与API
**FastAPI现代Web框架**
- **用途**: 构建高性能RESTful API服务
- **版本**: v0.104.1+
- **许可证**: MIT License
- **官网**: https://fastapi.tiangolo.com
- **关键特性**:
  - 自动API文档生成(OpenAPI/Swagger)
  - 基于类型提示的数据验证
  - 原生异步支持
  - 高性能(与NodeJS和Go相当)
- **在项目中的应用**:
  - 后端API服务主框架
  - WebSocket实时通信
  - 自动API文档生成

**fastmcp MCP协议框架**
- **用途**: Model Context Protocol服务通信
- **版本**: v0.1.0+
- **许可证**: MIT License
- **特性**: 支持工具调用、服务发现、消息路由
- **在项目中的应用**:
  - 智能体与微服务通信
  - 工具调用标准化
  - 服务间协议统一

#### (3) 前端技术栈
**Vue.js 3渐进式框架**
- **用途**: 构建响应式用户界面
- **版本**: v3.3.0+
- **许可证**: MIT License
- **官网**: https://vuejs.org
- **关键特性**:
  - Composition API支持
  - 更好的TypeScript集成
  - 更小的包体积和更快的渲染
  - 响应式数据绑定
- **在项目中的应用**:
  - 前端主框架
  - 组件化开发
  - 状态管理

**TailwindCSS原子化CSS**
- **用途**: 快速构建现代化UI界面
- **版本**: v3.3.0+
- **许可证**: MIT License
- **官网**: https://tailwindcss.com
- **设计理念**: 实用优先的CSS框架
- **在项目中的应用**:
  - UI样式系统
  - 响应式设计
  - 主题定制

**DaisyUI组件库**
- **用途**: 基于TailwindCSS的组件库
- **版本**: v3.9.0+
- **许可证**: MIT License
- **特性**: 提供预设计的UI组件
- **在项目中的应用**:
  - 快速UI开发
  - 一致的设计语言
  - 主题切换支持

#### (4) 数据可视化组件
**ECharts图表库**
- **用途**: 攻击路径、网络拓扑、统计图表可视化
- **版本**: v5.4.0+
- **许可证**: Apache License 2.0
- **开发商**: 百度开源
- **官网**: https://echarts.apache.org
- **特性**:
  - 丰富的图表类型(折线图、柱状图、关系图、桑基图等)
  - 支持大数据量渲染(百万级数据点)
  - 交互式图表操作
  - 主题定制和动画效果
- **在项目中的应用**:
  - 攻击路径可视化
  - 演练统计图表
  - 实时监控面板
  - 评估结果展示

**Fabric.js 2D画布库**
- **用途**: 网络拓扑图绘制和交互
- **版本**: v5.3.0+
- **许可证**: MIT License
- **官网**: http://fabricjs.com
- **特性**:
  - 强大的2D画布操作
  - 对象选择、拖拽、缩放
  - 自定义图形绘制
  - 事件处理机制
- **在项目中的应用**:
  - 拖拽式拓扑编辑
  - 实时网络状态可视化
  - 攻击路径动画展示
  - 交互式场景配置

#### (5) 容器化与编排
**Docker容器平台**
- **用途**: 应用容器化和环境隔离
- **版本**: v20.10+
- **许可证**: Apache License 2.0
- **官网**: https://docker.com
- **核心组件**:
  - Docker Engine: 容器运行时
  - Docker Compose: 多容器编排
  - Docker Registry: 镜像仓库
- **在项目中的应用**:
  - 智能体服务容器化
  - 靶场环境隔离
  - 开发环境统一
  - 生产部署标准化

**Kubernetes容器编排**
- **用途**: 生产环境容器集群管理
- **版本**: v1.24+
- **许可证**: Apache License 2.0
- **CNCF项目**: 云原生计算基金会毕业项目
- **官网**: https://kubernetes.io
- **在项目中的应用**:
  - 大规模部署管理
  - 服务自动扩缩容
  - 负载均衡和服务发现
  - 滚动更新和回滚

#### (6) 数据库与存储
**PostgreSQL关系数据库**
- **用途**: 主要业务数据存储
- **版本**: v15+
- **许可证**: PostgreSQL License
- **官网**: https://postgresql.org
- **特性**:
  - ACID事务支持
  - 丰富的数据类型(JSON、数组、范围类型等)
  - 强大的查询优化器
  - 扩展性强(支持自定义函数和插件)
- **在项目中的应用**:
  - 用户数据管理
  - 演练记录存储
  - 配置信息持久化
  - 审计日志记录

**Redis内存数据库**
- **用途**: 缓存、会话存储、实时数据
- **版本**: v7.0+
- **许可证**: BSD License
- **官网**: https://redis.io
- **数据结构**: 字符串、哈希、列表、集合、有序集合、流
- **在项目中的应用**:
  - 会话状态缓存
  - 实时数据存储
  - 消息队列
  - 分布式锁

**ChromaDB向量数据库**
- **用途**: 存储和检索MITRE ATT&CK知识库向量
- **版本**: v0.4.0+
- **许可证**: Apache License 2.0
- **官网**: https://trychroma.com
- **特性**:
  - 高效向量相似度搜索
  - 支持多种嵌入模型
  - 简单的Python API
  - 自动索引管理
- **在项目中的应用**:
  - 攻击技术知识检索
  - 相似场景推荐
  - 智能体知识增强
  - 语义搜索功能

#### (7) 安全工具集成
**Nmap网络扫描**
- **用途**: 网络发现和安全审计
- **版本**: v7.90+
- **许可证**: GPL License
- **官网**: https://nmap.org
- **Python集成**: python-nmap库封装
- **在项目中的应用**:
  - 网络拓扑发现
  - 端口扫描模拟
  - 服务识别
  - 漏洞检测

**Scapy网络包处理**
- **用途**: 网络包构造、发送和分析
- **版本**: v2.5.0+
- **许可证**: GPL License
- **官网**: https://scapy.net
- **特性**:
  - 灵活的包构造
  - 协议解析
  - 网络嗅探
  - 自定义协议支持
- **在项目中的应用**:
  - 自定义网络攻击模拟
  - 流量分析
  - 协议测试
  - 网络调试

#### (8) 机器学习与强化学习
**Stable-Baselines3强化学习**
- **用途**: 攻防策略智能优化
- **版本**: v2.2.1+
- **许可证**: MIT License
- **官网**: https://stable-baselines3.readthedocs.io
- **算法支持**: PPO、A2C、DQN、SAC、TD3等
- **特性**:
  - 易于使用的API
  - 完整的算法实现
  - 丰富的回调函数
  - TensorBoard集成
- **在项目中的应用**:
  - 攻击策略优化
  - 防御决策智能化
  - 自适应参数调整
  - 性能评估自动化

**PyTorch深度学习框架**
- **用途**: 神经网络模型训练和推理
- **版本**: v2.1.0+
- **许可证**: BSD License
- **开发商**: Meta(Facebook)
- **官网**: https://pytorch.org
- **特性**:
  - 动态计算图
  - 强大的GPU加速
  - 丰富的预训练模型
  - 活跃的社区生态
- **在项目中的应用**:
  - 强化学习模型训练
  - 自然语言处理
  - 行为模式识别
  - 异常检测算法

**Gymnasium强化学习环境**
- **用途**: 标准化的RL环境接口
- **版本**: v0.29.0+
- **许可证**: MIT License
- **官网**: https://gymnasium.farama.org
- **前身**: OpenAI Gym
- **在项目中的应用**:
  - 攻防环境建模
  - 智能体训练环境
  - 标准化接口实现
  - 环境状态管理

#### (9) 开发工具与质量保证
**pytest测试框架**
- **用途**: Python单元测试和集成测试
- **版本**: v7.4.0+
- **许可证**: MIT License
- **官网**: https://pytest.org
- **插件生态**: pytest-asyncio、pytest-cov、pytest-mock等
- **特性**:
  - 简洁的测试语法
  - 强大的fixture系统
  - 参数化测试
  - 详细的错误报告
- **在项目中的应用**:
  - API接口测试
  - 智能体功能测试
  - 集成测试自动化
  - 代码覆盖率检查

**ESLint代码检查**
- **用途**: JavaScript/TypeScript代码质量检查
- **版本**: v8.52.0+
- **许可证**: MIT License
- **官网**: https://eslint.org
- **特性**:
  - 可配置的规则系统
  - 自动修复功能
  - 插件扩展支持
  - IDE集成
- **在项目中的应用**:
  - 前端代码质量保证
  - 编码规范统一
  - 潜在错误检测
  - 代码风格一致性

**Prettier代码格式化**
- **用途**: 代码自动格式化
- **版本**: v3.0.0+
- **许可证**: MIT License
- **官网**: https://prettier.io
- **支持语言**: JavaScript、TypeScript、CSS、Markdown、JSON等
- **在项目中的应用**:
  - 代码格式统一
  - 自动化格式化
  - Git提交前检查
  - 团队协作规范

#### (10) 监控与日志
**Loguru现代日志库**
- **用途**: 结构化日志记录和管理
- **版本**: v0.7.0+
- **许可证**: MIT License
- **官网**: https://loguru.readthedocs.io
- **特性**:
  - 简洁的API设计
  - 自动日志轮转
  - 彩色输出支持
  - 异常追踪
- **在项目中的应用**:
  - 系统日志记录
  - 错误追踪
  - 性能监控
  - 调试信息输出

### 2.3.5 组件集成架构

本平台通过以下方式实现各组件的有机集成：

#### (1) 分层架构设计
```
┌─────────────────────────────────────┐
│           前端展示层                 │
│    Vue.js + TailwindCSS + ECharts   │
├─────────────────────────────────────┤
│           API网关层                  │
│         FastAPI + Uvicorn           │
├─────────────────────────────────────┤
│          智能体服务层                │
│    LangChain + LangGraph + fastmcp  │
├─────────────────────────────────────┤
│          业务逻辑层                  │
│   强化学习 + 安全工具 + 数据处理      │
├─────────────────────────────────────┤
│          数据存储层                  │
│  PostgreSQL + Redis + ChromaDB      │
├─────────────────────────────────────┤
│          基础设施层                  │
│      Docker + Kubernetes            │
└─────────────────────────────────────┘
```

#### (2) 组件通信机制
- **HTTP/REST**: 前后端标准通信
- **WebSocket**: 实时数据推送
- **MCP协议**: 智能体间通信
- **消息队列**: 异步任务处理
- **事件驱动**: 组件解耦通信

#### (3) 数据流转路径
- **用户操作** → **前端组件** → **API网关** → **业务逻辑** → **数据存储**
- **智能体决策** → **工具调用** → **结果处理** → **状态更新** → **前端展示**
- **实时监控** → **事件收集** → **数据分析** → **告警通知** → **响应处理**
三、开发说明

### 3.1 代码结构说明

本项目采用微服务架构设计，将智能体、服务层、前后端进行模块化分离，确保系统的可扩展性和可维护性。

#### 3.1.1 智能体模块 (agents/)

**1. 场景智能体 (scenario_agent/)**
- **功能**: 动态场景生成和拓扑管理
- **核心文件**:
  - `main.py`: 场景智能体主程序，集成DeepSeek LLM
  - `Dockerfile`: 容器化配置
  - `requirements.txt`: Python依赖管理
- **主要能力**:
  - 基于自然语言生成攻防场景
  - 动态拓扑结构创建
  - Docker Compose文件生成
  - 场景模板管理

**2. 攻击智能体 (attack_agent/)**
- **功能**: 智能化攻击模拟和执行
- **核心文件**:
  - `main.py`: 攻击智能体主程序
  - `Dockerfile`: 容器化部署配置
- **主要能力**:
  - 基于MITRE ATT&CK框架的攻击链执行
  - 自适应攻击策略选择
  - 实时攻击进度反馈
  - 多阶段攻击协调

**3. 中央控制智能体 (central_agent/)**
- **功能**: 攻防演练全局协调和控制
- **核心文件**:
  - `main.py`: 中央控制逻辑
  - `requirements.txt`: 依赖配置
- **主要能力**:
  - 演练流程编排
  - 智能体间通信协调
  - 全局状态管理
  - 演练进度监控

**4. 防御智能体集群 (defense_agent/)**
防御智能体采用分布式架构，包含多个专业化子智能体：

- **防御协调器 (defense_coordinator.py)**
  - 统一防御策略制定
  - 各防御智能体协调管理
  - 威胁态势感知
  - 防御资源调度

- **攻击溯源智能体 (attribution_agent.py)**
  - 攻击行为分析和溯源
  - 攻击路径重建
  - 威胁情报关联
  - 攻击者画像构建

- **威胁阻断智能体 (threat_blocking_agent.py)**
  - 实时威胁检测
  - 自动化阻断策略
  - 防火墙规则动态配置
  - 恶意流量拦截

- **漏洞修复智能体 (vulnerability_agent.py)**
  - 漏洞扫描和识别
  - 修复方案推荐
  - 补丁管理
  - 安全加固建议

- **攻防演练裁判 (battle_judge.py)**
  - 演练过程监督
  - 规则合规性检查
  - 实时评分计算
  - 公平性保障

- **启动脚本**:
  - `start_defense_coordinator.py`: 启动防御协调器
  - `start_defense_agents.py`: 批量启动防御智能体

**5. 评估智能体 (evaluate_agent/)**
- **功能**: 演练效果评估和报告生成
- **核心文件**: `main.py`
- **主要能力**:
  - 多维度评估指标计算
  - 智能化报告生成
  - 技能画像分析
  - 改进建议提供

**注**: `victim_host_agent/` 目录保留但当前版本中未激活使用，为后续扩展预留。

#### 3.1.2 微服务层 (services/)

**1. 场景服务 (scenario_service/)**
- **功能**: 场景模板管理和容器部署
- **核心文件**:
  - `main.py`: FastMCP服务主程序
  - `scenario_library/`: 场景模板库
- **服务能力**:
  - 场景模板CRUD操作
  - Docker容器编排
  - 网络拓扑配置
  - 资源监控管理

**2. 攻击服务 (attack_service/)**
- **功能**: 攻击工具集成和执行
- **核心文件**: `main.py`
- **工具集成**:
  - Nmap网络扫描
  - 漏洞利用框架
  - 自定义攻击脚本
  - 攻击效果验证

**3. 防御服务集群 (defense_service/)**
防御服务采用模块化设计，与防御智能体对应：

- **攻击溯源服务 (attribution_service.py)**
  - 日志分析和关联
  - 攻击链重建
  - 威胁情报查询
  - 溯源报告生成

- **威胁阻断服务 (threat_blocking_service.py)**
  - 实时流量监控
  - 异常行为检测
  - 自动化响应执行
  - 阻断效果评估

- **漏洞修复服务 (vulnerability_service.py)**
  - 漏洞数据库查询
  - 修复脚本执行
  - 补丁部署管理
  - 修复效果验证

- **服务启动脚本**: `start_defense_services.py`

**4. 评估服务 (evaluate_service/)**
- **功能**: 评估算法和数据分析
- **核心文件**: `main.py`
- **分析能力**:
  - 统计指标计算
  - 行为模式分析
  - 技能评估算法
  - 可视化数据生成

**5. 独立服务目录**
- `attribution_service/`: 攻击溯源独立服务
- `threat_blocking_service/`: 威胁阻断独立服务
- `vulnerability_service/`: 漏洞管理独立服务

#### 3.1.3 后端API服务 (backend/)

**核心架构**:
- **main.py**: FastAPI主程序，统一API网关
- **requirements.txt**: 后端Python依赖管理
- **utils/**: 工具函数和公共模块

**API功能模块**:
- 用户认证和权限管理
- 场景管理和部署控制
- 智能体生命周期管理
- 实时通信和WebSocket服务
- 日志收集和查询接口
- 评估报告生成接口

#### 3.1.4 前端应用 (src/)

**组件架构**:
- **views/**: 页面组件
  - 场景创建和管理页面
  - 攻防演练监控界面
  - 评估报告展示页面
  - 系统管理控制台

- **components/**: 可复用组件
  - 网络拓扑可视化组件
  - 实时日志展示组件
  - 图表和统计组件
  - 通用UI组件

- **stores/**: Pinia状态管理
  - 用户状态管理
  - 演练状态管理
  - 实时数据状态
  - 全局配置状态

- **router/**: Vue Router路由配置
- **services/**: API调用封装
- **assets/**: 静态资源文件

#### 3.1.5 支撑目录

**1. 容器化资源 (docker/)**
- `compose-templates/`: Docker Compose模板
- `images/`: 自定义镜像构建文件
- `networks/`: 网络配置文件

**2. 部署文档 (部署手册/)**
- 快速部署脚本
- 容器化部署指南
- 生产环境配置
- 故障排除文档

**3. 测试用例 (根目录测试文件)**
- `test_*.py`: 各模块功能测试
- 集成测试脚本
- 性能测试用例
- 自动化验证脚本

**4. 项目文档 (docs/)**
- 系统架构文档
- API接口文档
- 开发指南
- 用户手册

#### 3.1.6 架构特点

**1. 微服务化设计**
- 智能体和服务完全解耦
- 独立部署和扩展
- 容错和故障隔离
- 技术栈灵活选择

**2. 容器化部署**
- Docker统一环境
- Kubernetes集群管理
- 自动化CI/CD
- 弹性伸缩支持

**3. 模块化开发**
- 清晰的职责分离
- 标准化接口设计
- 可插拔组件架构
- 便于团队协作

**4. 实时通信**
- WebSocket双向通信
- MCP协议标准化
- 事件驱动架构
- 低延迟数据传输
3.2核心模块开发说明
    本项目四个核心模块的开发思路、关键技术、核心功能和实现要点的详细阐述如下：
3.2.1场景生成模块
场景生成模块的核心开发思路是利用场景智能体作为统一入口，将用户输入转换为可执行的部署指令。整个流程遵循 “提示词 -> 智能体分析 -> MCP 工具链生成 -> 前端渲染”的自动化路径，旨在实现场景的快速、按需构建。
1.前端交互与请求处理
用户在前端页面 Create.vue 中输入场景描述，包括业务场景和攻击类型。前端通过 ScenarioDataService.js 封装的 API，向后端 main.py 的 /api/scenario/process_request 端点发送请求。
2.智能体核心逻辑
后端将请求转发至部署在端口 8007 的场景智能体。智能体通过集成 DeepSeek LLM，对用户的提示词进行深度分析，提取出关键信息如业务场景、攻击方式。智能体随后调用其工具链中的核心工具，例如 generate_dynamic_scenario 或 parse_apt_ready_scenario，根据分析结果动态生成拓扑结构、节点属性和容器配置等。这些工具的输出是一个结构化的 JSON 数据，其中包含了完整的场景部署方案。
3.前端可视化与编辑
前端收到后端返回的 JSON 数据后，ScenarioDataService.js 负责将其转换为 TopologyView.vue 可用的数据格式。TopologyView.vue 使用 Fabric.js 等技术将拓扑结构进行可视化渲染，支持节点的智能布局和半透明渲染，为用户提供直观的编辑界面。

3.2.2攻击Agent模块
攻击 Agent 模块的核心在于自动化攻击流程，通过智能体和工具链的协同，模拟攻击者的行为，并将攻击过程实时反馈给前端。
1.前端交互与请求处理
前端通过 AttackAgentService.js 发起攻击请求，例如 executeAutoAttack（自动攻击）、startRealAttack（真实攻击）或 executeSocialEngineeringAttack（社会工程攻击）。这些请求通过后端 API（如 /api/attack/execute_full_attack）转发到攻击智能体。
2.智能体核心逻辑
攻击智能体（main.py）集成 DeepSeek LLM 和 MCP 工具链，作为攻击的 “大脑”。智能体根据请求和环境状态，自主选择攻击目标主机。它将调用一系列原子化的工具来执行攻击流程，例如：craft_phishing_email：生成钓鱼邮件。send_payload_to_victim：发送恶意载荷。search_exploit：根据侦察结果搜索可用的漏洞利用模块。execute_exploit_module：执行选定的漏洞利用。
3.实时日志与动画联动
攻击智能体在执行过程中，会通过 WebSocket 实时向前端推送标准化日志。前端的动画系统根据日志中的标准化关键词和 attack_info 字段，动态展示攻击链的进度和效果，例如扫描线、脉冲、路径高亮等。
3.2.3防御Agent模块
防御 Agent 模块的核心在于模拟防御措施的自动化响应，并与攻击 Agent 及场景智能体协同工作。该模块的设计遵循 “观察 -> 决策 -> 行动” 的循环，实现防御的联动性和自适应性 。
1.协同与通信
防御智能体通过 API 接口与后端服务、场景智能体进行通信。
它接收来自靶场环境的实时日志和攻击智能体的动作日志，作为决策依据。
2.模拟防御措施
防御智能体集成 MCP 服务的防御工具链，例如策略下发、日志分析、自动阻断等.当检测到攻击行为时，它会自主决策并调用相应的工具来执行防御动作，例如在防火墙上添加规则，或终止恶意进程。
3.状态展示与联动
防御 Agent 的行动结果，如防御事件日志，会通过 WebSocket 实时推送给前端.前端拓扑图上的节点状态、颜色变化以及服务面板将动态更新，向用户展示防御方的实时响应。
3.2.4演练评估模块
演练评估模块的核心在于全流程数据记录、多维度指标统计以及报告的自动化生成。该模块将演练过程中的所有数据转化为有价值的评估结果，实现“数据驱动”的评估。
1.数据记录与存储
后端主服务和所有智能体在演练过程中，都会实时记录攻击 / 防御日志、节点状态变化、容器部署情况等关键数据。
这些数据被存储在持久化数据库中，为后续的评估分析提供完整的数据集。
2.多维度指标统计
前端集成评估面板，实时展示关键指标，例如攻击链进度、攻击成功率、防御响应时间等。在演练结束后，后端会启动评估流程，对所有记录数据进行批量统计和计算，生成详细的评估指标。
3.自动化报告生成
平台支持将演练结果导出一份详尽的演练报告。报告将自动归档场景数据和日志，并结合统计指标，以图表和文字的形式呈现，帮助用户清晰地理解演练过程和表现。
4.自动化测试与验证
test_frontend_complete.py 和 test_phase2_frontend.py 等自动化测试脚本将作为评估模块的辅助工具，用于验证整个端到端流程的正确性和稳定性。通过这些测试，可以确保数据的准确记录和指标的正确统计，为评估结果的可靠性提供保障。
四、接口设计

本平台采用RESTful API设计规范，所有接口返回JSON格式数据。API基础路径为 `/api/v1`，支持HTTP和WebSocket两种通信方式。

### 4.1 接口规范说明

#### 4.1.1 通用响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2024-12-01T10:00:00Z"
}
```

#### 4.1.2 错误码定义
| 错误码 | 说明 | 示例 |
|--------|------|------|
| 200 | 成功 | 请求处理成功 |
| 400 | 请求参数错误 | 缺少必需参数 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 权限不足 | 无访问权限 |
| 404 | 资源不存在 | 接口或数据不存在 |
| 500 | 服务器内部错误 | 系统异常 |

#### 4.1.3 认证方式
- **Bearer Token**: 在请求头中添加 `Authorization: Bearer <token>`
- **Session**: 基于Cookie的会话认证（可选）

### 4.2 用户认证与账户管理

#### （1）用户登录接口
**功能简介**: 用户登录平台并获取身份令牌
**请求URL**: `/api/v1/auth/login`
**请求方式**: `POST`
**请求参数**:
```json
{
  "username": "string",
  "password": "string",
  "remember_me": "boolean"
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 3600,
    "user": {
      "id": "12345",
      "username": "admin",
      "role": "RedTeam",
      "permissions": ["agent:launch", "tools:manual-use"]
    }
  }
}
```
**失败响应**:
```json
{
  "code": 401,
  "message": "用户名或密码错误",
  "data": null
}
#### （2）用户注册接口
**功能简介**: 新用户账号注册
**请求URL**: `/api/v1/auth/register`
**请求方式**: `POST`
**请求参数**:
```json
{
  "username": "string",
  "password": "string",
  "email": "string",
  "role": "RedTeam | BlueTeam | Observer"
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user_id": "12345",
    "username": "newuser",
    "email": "user@example.com",
    "status": "active"
  }
}
```
**失败响应**:
```json
{
  "code": 400,
  "message": "用户名已存在",
  "data": null
}
```

#### （3）Token刷新接口
**功能简介**: 刷新访问令牌
**请求URL**: `/api/v1/auth/refresh`
**请求方式**: `POST`
**请求参数**:
```json
{
  "refresh_token": "string"
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "Token刷新成功",
  "data": {
    "token": "new_access_token",
    "expires_in": 3600
  }
}
```
### 4.3 场景管理接口

#### （1）创建动态场景接口
**功能简介**: 基于用户输入生成动态攻防场景
**请求URL**: `/api/v1/scenario/create`
**请求方式**: `POST`
**请求参数**:
```json
{
  "name": "医疗APT攻击场景",
  "description": "针对医院信息系统的高级持续威胁攻击",
  "business_scenario": "healthcare",
  "attack_type": "apt",
  "complexity": "high",
  "custom_config": {
    "target_systems": ["his", "pacs", "lis"],
    "network_size": "medium",
    "vulnerability_level": "high"
  }
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "场景创建成功",
  "data": {
    "scenario_id": "scenario_001",
    "name": "医疗APT攻击场景",
    "status": "created",
    "compose_file": "/scenarios/healthcare_apt_001.yml",
    "topology": {
      "nodes": [
        {
          "id": "web-server",
          "type": "server",
          "ip": "192.168.1.10",
          "services": ["nginx", "php"]
        },
        {
          "id": "db-server",
          "type": "database",
          "ip": "192.168.1.20",
          "services": ["mysql"]
        }
      ],
      "networks": [
        {
          "name": "frontend",
          "subnet": "192.168.1.0/24"
        }
      ]
    },
    "services_count": 5,
    "networks_count": 2
  }
}
```

#### （2）部署场景容器接口
**功能简介**: 部署指定场景的Docker容器
**请求URL**: `/api/v1/scenario/deploy`
**请求方式**: `POST`
**请求参数**:
```json
{
  "scenario_id": "scenario_001",
  "deployment_config": {
    "auto_start": true,
    "resource_limits": {
      "cpu": "2",
      "memory": "4G"
    }
  }
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "场景部署成功",
  "data": {
    "deployment_id": "deploy_001",
    "status": "running",
    "containers": [
      {
        "name": "web-server",
        "container_id": "abc123",
        "status": "running",
        "ip": "192.168.1.10"
      }
    ],
    "access_urls": [
      "http://192.168.1.10:80"
    ]
  }
}
```

#### （3）获取场景列表接口
**功能简介**: 获取用户可用的场景列表
**请求URL**: `/api/v1/scenario/list`
**请求方式**: `GET`
**请求参数**:
- `page`: 页码 (可选)
- `size`: 每页数量 (可选)
- `status`: 场景状态过滤 (可选)

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 10,
    "page": 1,
    "size": 10,
    "scenarios": [
      {
        "id": "scenario_001",
        "name": "医疗APT攻击场景",
        "business_scenario": "healthcare",
        "attack_type": "apt",
        "status": "deployed",
        "created_at": "2024-12-01T10:00:00Z",
        "updated_at": "2024-12-01T10:30:00Z"
      }
    ]
  }
}
```

#### （4）删除场景接口
**功能简介**: 删除指定场景及其容器
**请求URL**: `/api/v1/scenario/{scenario_id}`
**请求方式**: `DELETE`
**成功响应**:
```json
{
  "code": 200,
  "message": "场景删除成功",
  "data": {
    "scenario_id": "scenario_001",
    "containers_removed": 5,
    "networks_removed": 2
  }
}
```

### 4.6 人员操作设计与工具控制

#### （1）设置用户角色与工具权限接口
**功能简介**: 设置用户在演练中的角色身份及其可使用的工具权限
**请求URL**: `/api/v1/user/set-role-tools`
**请求方式**: `POST`
**请求参数**:
```json
{
  "user_id": "user_001",
  "role": "RedTeam | BlueTeam | Observer",
  "tool_permissions": {
    "agent_enabled": true,
    "manual_tools_enabled": false,
    "available_tools": [
      {
        "tool_id": "nmap",
        "tool_name": "网络扫描工具",
        "enabled": true,
        "require_approval": false
      },
      {
        "tool_id": "metasploit",
        "tool_name": "渗透测试框架",
        "enabled": false,
        "require_approval": true
      },
      {
        "tool_id": "wireshark",
        "tool_name": "网络抓包工具",
        "enabled": true,
        "require_approval": false
      }
    ]
  }
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "角色和工具权限设置成功",
  "data": {
    "user_id": "user_001",
    "role": "RedTeam",
    "redirect_to": "/dashboard/red-team",
    "effective_permissions": {
      "agent_access": true,
      "manual_tools_count": 2,
      "restricted_tools_count": 1
    }
  }
}
```

#### （2）动态工具开关控制接口
**功能简介**: 实时控制用户可用工具的开关状态
**请求URL**: `/api/v1/user/tools/toggle`
**请求方式**: `POST`
**请求参数**:
```json
{
  "user_id": "user_001",
  "tool_id": "metasploit",
  "action": "enable | disable",
  "reason": "演练阶段调整",
  "notify_user": true
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "工具状态更新成功",
  "data": {
    "tool_id": "metasploit",
    "tool_name": "渗透测试框架",
    "previous_status": "disabled",
    "current_status": "enabled",
    "updated_at": "2024-12-01T10:30:00Z",
    "notification_sent": true
  }
}
```

#### （3）Agent工具调用权限检查接口
**功能简介**: Agent调用工具前的权限验证接口
**请求URL**: `/api/v1/agent/tools/check-permission`
**请求方式**: `POST`
**请求参数**:
```json
{
  "agent_id": "attack_agent_001",
  "user_id": "user_001",
  "tool_id": "nmap",
  "tool_action": "port_scan",
  "target": "192.168.1.10",
  "context": {
    "scenario_id": "scenario_001",
    "attack_phase": "reconnaissance"
  }
}
```
**成功响应（有权限）**:
```json
{
  "code": 200,
  "message": "工具调用权限验证通过",
  "data": {
    "permission_granted": true,
    "tool_config": {
      "max_execution_time": 300,
      "allowed_targets": ["192.168.1.0/24"],
      "restricted_options": []
    }
  }
}
```
**失败响应（无权限）**:
```json
{
  "code": 403,
  "message": "工具调用权限不足",
  "data": {
    "permission_granted": false,
    "reason": "工具已被管理员禁用",
    "require_approval": true,
    "approval_request_id": "approval_001"
  }
}
```

#### （4）工具调用审批请求接口
**功能简介**: Agent尝试调用受限工具时发起审批请求
**请求URL**: `/api/v1/agent/tools/request-approval`
**请求方式**: `POST`
**请求参数**:
```json
{
  "agent_id": "attack_agent_001",
  "user_id": "user_001",
  "tool_id": "metasploit",
  "tool_action": "exploit_execution",
  "target": "192.168.1.20",
  "justification": "需要验证目标系统的漏洞利用可行性",
  "urgency": "medium",
  "context": {
    "scenario_id": "scenario_001",
    "attack_phase": "exploitation"
  }
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "审批请求已提交",
  "data": {
    "approval_request_id": "approval_001",
    "status": "pending",
    "submitted_at": "2024-12-01T10:35:00Z",
    "estimated_response_time": "5 minutes",
    "approvers": ["admin_001", "instructor_001"]
  }
}
```

#### （5）工具调用审批处理接口
**功能简介**: 管理员/教练员处理工具调用审批请求
**请求URL**: `/api/v1/admin/tools/approve`
**请求方式**: `POST`
**请求参数**:
```json
{
  "approval_request_id": "approval_001",
  "action": "approve | reject",
  "approver_id": "admin_001",
  "comments": "同意使用，但限制执行时间为10分钟",
  "conditions": {
    "time_limit": 600,
    "monitoring_required": true,
    "auto_stop_on_success": true
  }
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "审批处理完成",
  "data": {
    "approval_request_id": "approval_001",
    "status": "approved",
    "approved_at": "2024-12-01T10:40:00Z",
    "approver": "admin_001",
    "conditions_applied": true,
    "notification_sent": true
  }
}
```

#### （6）获取用户工具权限状态接口
**功能简介**: 获取当前用户的工具权限和状态信息
**请求URL**: `/api/v1/user/tools/status`
**请求方式**: `GET`
**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "user_id": "user_001",
    "role": "RedTeam",
    "agent_enabled": true,
    "tools": [
      {
        "tool_id": "nmap",
        "tool_name": "网络扫描工具",
        "category": "reconnaissance",
        "status": "enabled",
        "last_used": "2024-12-01T10:20:00Z",
        "usage_count": 5,
        "restrictions": []
      },
      {
        "tool_id": "metasploit",
        "tool_name": "渗透测试框架",
        "category": "exploitation",
        "status": "disabled",
        "disabled_reason": "需要审批",
        "require_approval": true,
        "pending_requests": 1
      }
    ],
    "permissions": [
      "agent:launch",
      "tools:basic-use",
      "logs:view"
    ],
    "available_views": [
      "/tools/reconnaissance",
      "/tools/exploitation",
      "/logs/attack"
    ]
  }
}
```

### 4.7 WebSocket实时通信接口

#### （1）工具状态变更通知
**功能简介**: 当工具权限发生变更时，实时通知相关用户和Agent
**WebSocket URL**: `/ws/v1/tool-notifications`
**消息格式**:
```json
{
  "type": "tool_status_changed",
  "timestamp": "2024-12-01T10:45:00Z",
  "data": {
    "user_id": "user_001",
    "tool_id": "metasploit",
    "tool_name": "渗透测试框架",
    "old_status": "disabled",
    "new_status": "enabled",
    "reason": "管理员审批通过",
    "effective_immediately": true
  }
}
```

#### （2）Agent工具调用被拒绝通知
**功能简介**: 当Agent尝试调用被禁用的工具时，通知用户进行操作
**WebSocket URL**: `/ws/v1/agent-notifications`
**消息格式**:
```json
{
  "type": "tool_access_denied",
  "timestamp": "2024-12-01T10:50:00Z",
  "data": {
    "agent_id": "attack_agent_001",
    "agent_name": "攻击智能体",
    "user_id": "user_001",
    "tool_id": "metasploit",
    "tool_name": "渗透测试框架",
    "requested_action": "exploit_execution",
    "target": "192.168.1.20",
    "denial_reason": "工具已被禁用",
    "suggested_actions": [
      {
        "action": "request_approval",
        "label": "申请使用权限",
        "api_endpoint": "/api/v1/agent/tools/request-approval"
      },
      {
        "action": "use_alternative",
        "label": "使用替代工具",
        "alternatives": ["custom_exploit", "manual_verification"]
      }
    ]
  }
}
```

#### （3）审批请求通知
**功能简介**: 向管理员/教练员发送工具使用审批请求通知
**WebSocket URL**: `/ws/v1/approval-notifications`
**消息格式**:
```json
{
  "type": "approval_request",
  "timestamp": "2024-12-01T10:52:00Z",
  "data": {
    "approval_request_id": "approval_001",
    "requester": {
      "user_id": "user_001",
      "username": "red_team_member",
      "agent_id": "attack_agent_001"
    },
    "tool_request": {
      "tool_id": "metasploit",
      "tool_name": "渗透测试框架",
      "action": "exploit_execution",
      "target": "192.168.1.20",
      "justification": "需要验证目标系统的漏洞利用可行性"
    },
    "urgency": "medium",
    "context": {
      "scenario_id": "scenario_001",
      "attack_phase": "exploitation"
    },
    "actions": [
      {
        "action": "approve",
        "label": "批准",
        "api_endpoint": "/api/v1/admin/tools/approve"
      },
      {
        "action": "reject",
        "label": "拒绝",
        "api_endpoint": "/api/v1/admin/tools/approve"
      }
    ]
  }
}
```

### 4.8 Agent控制与演练管理

#### （1）启动攻击Agent接口
**功能简介**: 启动红队攻击Agent，执行自动化渗透任务
**请求URL**: `/api/v1/agent/attack/start`
**请求方式**: `POST`
**请求参数**:
```json
{
  "scenario_id": "scenario_001",
  "target_systems": ["web-server", "db-server"],
  "attack_strategy": "default | stealth | aggressive | custom",
  "user_id": "user_001",
  "config": {
    "max_duration": 3600,
    "stealth_mode": true,
    "auto_escalate": false,
    "tool_restrictions": ["no_destructive_actions"]
  }
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "攻击Agent启动成功",
  "data": {
    "agent_session_id": "attack_session_001",
    "agent_id": "attack_agent_001",
    "status": "running",
    "start_time": "2024-12-01T11:00:00Z",
    "estimated_duration": "60 minutes",
    "available_tools": ["nmap", "nikto", "sqlmap"],
    "restricted_tools": ["metasploit"],
    "monitoring_url": "/ws/v1/agent-monitoring/attack_session_001"
  }
}
```

#### （2）启动防御Agent接口
**功能简介**: 启动蓝队防御Agent，开始监测和响应攻击
**请求URL**: `/api/v1/agent/defense/start`
**请求方式**: `POST`
**请求参数**:
```json
{
  "scenario_id": "scenario_001",
  "attack_session_id": "attack_session_001",
  "defense_strategy": "reactive | proactive | adaptive",
  "user_id": "user_002",
  "config": {
    "monitoring_level": "high",
    "auto_response": true,
    "alert_threshold": "medium",
    "response_delay": 30
  }
}
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "防御Agent启动成功",
  "data": {
    "agent_session_id": "defense_session_001",
    "agent_id": "defense_agent_001",
    "status": "active",
    "start_time": "2024-12-01T11:05:00Z",
    "monitoring_targets": ["web-server", "db-server", "network"],
    "deployed_sensors": [
      {
        "type": "network_monitor",
        "location": "gateway",
        "status": "active"
      },
      {
        "type": "endpoint_agent",
        "location": "all_servers",
        "status": "active"
      }
    ]
  }
}
```

#### （3）获取Agent状态接口
**功能简介**: 获取攻击或防御Agent当前运行状态和详细信息
**请求URL**: `/api/v1/agent/status/{agent_session_id}`
**请求方式**: `GET`
**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "agent_session_id": "attack_session_001",
    "agent_type": "attack",
    "status": "running",
    "current_phase": "exploitation",
    "current_task": "SQL注入攻击",
    "progress": {
      "completed_phases": ["reconnaissance", "weaponization", "delivery"],
      "current_phase_progress": 0.6,
      "overall_progress": 0.45
    },
    "statistics": {
      "tools_used": 5,
      "successful_actions": 8,
      "failed_actions": 2,
      "targets_compromised": 1
    },
    "active_tools": ["sqlmap", "burpsuite"],
    "next_planned_action": "权限提升",
    "estimated_completion": "2024-12-01T11:30:00Z"
  }
}
```

#### （4）停止Agent接口
**功能简介**: 停止指定的Agent会话
**请求URL**: `/api/v1/agent/stop/{agent_session_id}`
**请求方式**: `POST`
**请求参数**:
```json
{
  "reason": "用户手动停止",
  "force_stop": false,
  "cleanup_resources": true
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "Agent已成功停止",
  "data": {
    "agent_session_id": "attack_session_001",
    "stopped_at": "2024-12-01T11:15:00Z",
    "final_status": "stopped_by_user",
    "session_summary": {
      "duration": "15 minutes",
      "actions_completed": 10,
      "targets_affected": 2,
      "data_collected": "1.2MB"
    }
  }
}
```

### 4.9 行为日志与监控接口

#### （1）获取实时行为日志接口
**功能简介**: 获取当前演练的实时行为日志
**请求URL**: `/api/v1/logs/realtime`
**请求方式**: `GET`
**请求参数**:
- `session_id`: 演练会话ID
- `agent_type`: Agent类型过滤 (可选)
- `log_level`: 日志级别过滤 (可选)
- `limit`: 返回条数限制 (可选)

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "session_id": "exercise_001",
    "total_logs": 156,
    "logs": [
      {
        "log_id": "log_001",
        "timestamp": "2024-12-01T11:10:00Z",
        "agent_type": "attack",
        "agent_id": "attack_agent_001",
        "log_level": "info",
        "action": "port_scan",
        "target": "192.168.1.10",
        "result": "success",
        "details": "发现开放端口: 22, 80, 443",
        "mitre_technique": "T1046",
        "tool_used": "nmap"
      },
      {
        "log_id": "log_002",
        "timestamp": "2024-12-01T11:12:00Z",
        "agent_type": "defense",
        "agent_id": "defense_agent_001",
        "log_level": "warning",
        "action": "anomaly_detected",
        "target": "network_traffic",
        "result": "alert_generated",
        "details": "检测到异常端口扫描活动",
        "response_action": "增强监控"
      }
    ]
  }
}
```

#### （2）查询历史行为日志接口
**功能简介**: 查询指定时间范围内的历史行为日志
**请求URL**: `/api/v1/logs/history`
**请求方式**: `GET`
**请求参数**:
- `start_time`: 开始时间
- `end_time`: 结束时间
- `session_id`: 会话ID (可选)
- `user_id`: 用户ID (可选)
- `action_type`: 行为类型 (可选)

**成功响应**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total_count": 89,
    "page": 1,
    "page_size": 20,
    "logs": [
      {
        "log_id": "log_hist_001",
        "session_id": "exercise_001",
        "timestamp": "2024-12-01T10:30:00Z",
        "user_id": "user_001",
        "action_type": "tool_usage",
        "action_details": {
          "tool_name": "nmap",
          "command": "nmap -sS 192.168.1.0/24",
          "execution_time": 45,
          "results_count": 12
        },
        "impact_level": "low"
      }
    ]
  }
}
```

### 4.10 攻击图谱与可视化接口

#### （1）获取攻击图谱数据接口
**功能简介**: 获取当前演练的攻击图谱和行为关系数据
**请求URL**: `/api/v1/graph/attack-graph`
**请求方式**: `GET`
**请求参数**:
- `session_id`: 演练会话ID
- `time_range`: 时间范围 (可选)
- `include_defense`: 是否包含防御行为 (可选)

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "session_id": "exercise_001",
    "graph_data": {
      "nodes": [
        {
          "id": "node_001",
          "type": "action",
          "category": "reconnaissance",
          "title": "端口扫描",
          "description": "对目标网络进行端口扫描",
          "timestamp": "2024-12-01T10:10:00Z",
          "actor": "attack_agent",
          "target": "192.168.1.0/24",
          "mitre_technique": "T1046",
          "success": true,
          "impact_level": "low"
        },
        {
          "id": "node_002",
          "type": "action",
          "category": "initial_access",
          "title": "SQL注入攻击",
          "description": "利用SQL注入漏洞获取数据库访问权限",
          "timestamp": "2024-12-01T10:25:00Z",
          "actor": "attack_agent",
          "target": "web-server",
          "mitre_technique": "T1190",
          "success": true,
          "impact_level": "high"
        }
      ],
      "edges": [
        {
          "id": "edge_001",
          "source": "node_001",
          "target": "node_002",
          "relationship": "enables",
          "description": "端口扫描发现的Web服务为SQL注入攻击提供了目标"
        }
      ]
    },
    "statistics": {
      "total_nodes": 15,
      "attack_nodes": 12,
      "defense_nodes": 3,
      "success_rate": 0.8
    }
  }
}
```

#### （2）查询图谱节点详情接口
**功能简介**: 获取指定图谱节点的详细信息和相关数据
**请求URL**: `/api/v1/graph/node/{node_id}`
**请求方式**: `GET`
**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "node_id": "node_002",
    "basic_info": {
      "type": "action",
      "category": "initial_access",
      "title": "SQL注入攻击",
      "description": "利用SQL注入漏洞获取数据库访问权限",
      "timestamp": "2024-12-01T10:25:00Z"
    },
    "technical_details": {
      "mitre_technique": "T1190",
      "tool_used": "sqlmap",
      "command_executed": "sqlmap -u 'http://192.168.1.10/login.php' --dbs",
      "vulnerability": "CVE-2021-1234",
      "payload": "' UNION SELECT 1,2,3,database()--",
      "execution_time": 120
    },
    "impact_analysis": {
      "impact_level": "high",
      "affected_systems": ["web-server", "database"],
      "data_accessed": ["user_credentials", "patient_records"],
      "business_impact": "数据泄露风险"
    },
    "related_nodes": [
      {
        "node_id": "node_001",
        "relationship": "prerequisite",
        "title": "端口扫描"
      },
      {
        "node_id": "node_003",
        "relationship": "consequence",
        "title": "权限提升"
      }
    ]
  }
}
```

### 4.11 评估报告与分析接口

#### （1）生成评估报告接口
**功能简介**: 生成指定演练的综合评估报告
**请求URL**: `/api/v1/evaluation/generate-report`
**请求方式**: `POST`
**请求参数**:
```json
{
  "session_id": "exercise_001",
  "report_type": "comprehensive | summary | technical",
  "participants": ["user_001", "user_002", "user_003"],
  "evaluation_criteria": {
    "include_skill_assessment": true,
    "include_team_performance": true,
    "include_technical_analysis": true,
    "include_recommendations": true
  },
  "output_format": "pdf | html | json"
}
```
**成功响应**:
```json
{
  "code": 200,
  "message": "评估报告生成成功",
  "data": {
    "report_id": "report_001",
    "report_url": "/reports/exercise_001_comprehensive.pdf",
    "generation_time": "2024-12-01T12:00:00Z",
    "summary": {
      "overall_score": 8.5,
      "team_performance": "良好",
      "exercise_duration": "90 minutes",
      "objectives_completed": 8,
      "objectives_total": 10
    },
    "key_findings": [
      "威胁检测能力较强，平均响应时间35秒",
      "团队协作效率有待提升",
      "工具使用熟练度良好"
    ],
    "participant_scores": [
      {
        "user_id": "user_001",
        "username": "red_team_leader",
        "overall_score": 9.2,
        "role_performance": "优秀",
        "strengths": ["战术规划", "工具使用"],
        "improvements": ["时间管理"]
      }
    ]
  }
}
```

### 4.12 系统管理与监控接口

#### （1）获取系统运行状态接口
**功能简介**: 获取平台整体运行状态和资源使用情况
**请求URL**: `/api/v1/admin/system/status`
**请求方式**: `GET`
**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "system_health": "healthy",
    "uptime": "72 hours 15 minutes",
    "resource_usage": {
      "cpu_usage": "37%",
      "memory_usage": "65%",
      "disk_usage": "45%",
      "network_io": "125 MB/s"
    },
    "service_status": {
      "api_gateway": "running",
      "database": "running",
      "redis": "running",
      "agents": {
        "scenario_agent": "running",
        "attack_agent": "running",
        "defense_agent": "running",
        "evaluate_agent": "running"
      }
    },
    "active_sessions": {
      "total": 3,
      "attack_sessions": 2,
      "defense_sessions": 1
    },
    "performance_metrics": {
      "avg_response_time": "120ms",
      "requests_per_minute": 450,
      "error_rate": "0.02%"
    }
  }
}
```

#### （2）获取历史演练记录接口
**功能简介**: 查询历史演练记录和基本统计信息
**请求URL**: `/api/v1/admin/exercises/history`
**请求方式**: `GET`
**请求参数**:
- `page`: 页码 (可选)
- `size`: 每页数量 (可选)
- `start_date`: 开始日期 (可选)
- `end_date`: 结束日期 (可选)
- `user_id`: 用户ID过滤 (可选)

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total_count": 156,
    "page": 1,
    "page_size": 20,
    "exercises": [
      {
        "session_id": "exercise_001",
        "scenario_name": "医疗APT攻击场景",
        "start_time": "2024-12-01T09:00:00Z",
        "end_time": "2024-12-01T10:30:00Z",
        "duration": "90 minutes",
        "participants": [
          {
            "user_id": "user_001",
            "role": "RedTeam",
            "score": 8.5
          },
          {
            "user_id": "user_002",
            "role": "BlueTeam",
            "score": 7.8
          }
        ],
        "overall_score": 8.2,
        "status": "completed",
        "objectives_completed": 8,
        "objectives_total": 10
      }
    ],
    "statistics": {
      "avg_score": 8.1,
      "avg_duration": "85 minutes",
      "completion_rate": 0.92
    }
  }
}
```

#### （3）观察者实时视图接口
**功能简介**: 获取当前演练的实时可视化信息（观察者模式）
**请求URL**: `/api/v1/observer/current-view`
**请求方式**: `GET`
**请求参数**:
- `session_id`: 演练会话ID

**成功响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "session_id": "exercise_001",
    "view_type": "topology",
    "active_participants": [
      {
        "user_id": "user_001",
        "role": "RedTeam",
        "status": "active",
        "current_action": "SQL注入攻击"
      },
      {
        "user_id": "user_002",
        "role": "BlueTeam",
        "status": "responding",
        "current_action": "分析异常流量"
      }
    ],
    "network_topology": {
      "nodes": [
        {
          "id": "web-server",
          "status": "compromised",
          "threat_level": "high",
          "active_connections": 5
        },
        {
          "id": "db-server",
          "status": "normal",
          "threat_level": "medium",
          "active_connections": 2
        }
      ],
      "active_attacks": [
        {
          "attack_id": "attack_001",
          "source": "external",
          "target": "web-server",
          "type": "sql_injection",
          "progress": 0.7
        }
      ]
    },
    "real_time_metrics": {
      "attacks_detected": 5,
      "attacks_blocked": 2,
      "response_time_avg": "45 seconds",
      "current_threat_level": "medium"
    }
  }
}
```

#### （4）WebSocket演练进度订阅
**功能简介**: 实时监听演练进度和状态变化
**WebSocket URL**: `/ws/v1/observer/subscribe/{session_id}`
**消息格式**:
```json
{
  "type": "exercise_progress",
  "timestamp": "2024-12-01T11:30:00Z",
  "session_id": "exercise_001",
  "data": {
    "event_type": "attack_action",
    "actor": {
      "user_id": "user_001",
      "role": "RedTeam",
      "agent_id": "attack_agent_001"
    },
    "action": {
      "type": "exploitation",
      "target": "web-server",
      "technique": "T1190",
      "tool": "sqlmap",
      "result": "success"
    },
    "impact": {
      "systems_affected": ["web-server"],
      "data_accessed": ["user_database"],
      "threat_level_change": "medium -> high"
    },
    "graph_update": {
      "new_nodes": ["node_005"],
      "new_edges": ["edge_003"],
      "updated_nodes": ["node_002"]
    }
  }
}
```

### 4.13 错误处理和状态码

#### 常见错误响应格式
```json
{
  "code": 400,
  "message": "请求参数错误",
  "error_details": {
    "field": "tool_id",
    "reason": "工具ID不能为空",
    "suggestion": "请提供有效的工具ID"
  },
  "timestamp": "2024-12-01T12:00:00Z"
}
```

#### 业务逻辑错误示例
```json
{
  "code": 409,
  "message": "操作冲突",
  "error_details": {
    "reason": "Agent正在执行任务，无法停止",
    "current_status": "executing_critical_operation",
    "suggestion": "请等待当前操作完成后再试"
  }
}
```

6.评估报告与复盘查询
（1）获取评估报告接口
功能简介： 获取指定场景演练的自动化评估报告。 请求URL： /api/evaluation/report 请求方式： GET 参数设置： ?sessionId=string 成功数据返回：
{
  "score": 87,
  "categories": {
    "attackSuccess": 0.8,
    "defenseAdaptation": 0.9,
    "responseDelay": "35s"
  },
  "summary": "RedTeam successfully compromised two targets, but BlueTeam contained the attack in 90s."
}
（2） 获取复盘回放接口
功能简介： 返回整场演练的时序回放数据。 请求URL： /api/evaluation/replay 请求方式： GET 参数设置： ?sessionId=string 成功数据返回：
{
  "events": [
    {"time": "00:00", "event": "攻击Agent启动"},
    {"time": "00:15", "event": "目标主机被渗透"}
  ]
}

7.系统管理与审计接口
（1）获取所有历史演练接口
功能简介： 查询历史演练记录和基本指标。 请求URL： /api/admin/history 请求方式： GET 成功数据返回：
[
  {
    "sessionId": "abc123",
    "startTime": "2025-07-01T08:00:00Z",
    "endTime": "2025-07-01T08:45:00Z",
    "score": 83
  }
]
（2）系统运行状态接口
功能简介： 查询系统资源使用情况。 请求URL： /api/admin/status 请求方式： GET 成功数据返回：
{
  "cpuUsage": "37%",
  "memoryUsage": "65%",
  "activeSessions": 3
}
五、数据库设计
本项目数据库设计如下：
1.场景配置与资源模块
该模块负责描述演练场景的基础配置、网络资源、漏洞信息及部署情况，为演练任务提供环境支撑。由动态场景配置表（scene_config）、子场景任务表（scene_subtask）、组件信息表（component_info）、漏洞信息表（vulnerability_info）、网络拓扑表（network_topology）和容器部署表（container_deploy）组成,如图所示：

图3-2 场景配置E-R图
(1)动态场景配置表（scene_config）
该表定义了每个演练场景的基本属性，包括名称、描述、创建者、状态，是整个系统的场景入口。
(2)子场景任务表（scene_subtask）
该表用于细化场景中的任务目标，可关联指标、拓扑节点、漏洞等。
(3)组件信息表（component_info）
该表描述构成场景的服务组件及其版本、端口等信息，并可与漏洞关联。
(4)漏洞信息表（vulnerability_info）
该表记录可用于演练的漏洞资源，包括 CVE 编号、利用条件、影响范围、适用组件等。
(5)网络拓扑表（network_topology）
该表存储场景网络结构的信息，如节点数量、链路关系、防火墙配置等，用于仿真网络环境。
(6)容器部署表（container_deploy）
该表管理与场景相关联的容器部署状态，记录部署时间、网络地址、运行状态等，为虚拟化部署提供支持。
数据库表详情请见附录。
2.演练任务与行为模块
该模块聚焦于演练过程的任务调度、行为记录与图谱建模，便于重建攻防过程与行为评估。由行为路径表（behavior_path）、行为图谱节点表（behavior_graph_node）、演练任务表（exercise_task）、攻击行为日志表（attack_log）、防御行为日志表（defense_log）、网络流量表（network_traffic）组成，如图所示：

图3-3 演练任务与行为E-R图
(1)行为路径表（behavior_path）
该表记录完整的演练活动，包括关联场景、红蓝队参与方、时间窗口与自动得分等。
(2)行为图谱节点表（behavior_graph_node）
该表以图节点方式表达演练中关键行为事件，支持行为轨迹可视化与评估。
(3)演练任务表（exercise_task）
该表记录完整的演练活动，包括关联场景、红蓝队参与方、时间窗口与自动得分等。
(4)攻击行为日志表（attack_log）
该表分别记录攻击方的行为动作、使用工具、执行效果等，构成行为原始数据。
(5)防御行为日志表（defense_log）
该表分别记录防御方的行为动作、使用工具、执行效果等，构成行为原始数据。
(6)网络流量表（network_traffic）
该表捕获演练中的关键网络通信记录，用于分析异常流量、判定攻击特征等。
数据库表详情请见附录。
3.用户与智能体参与模块
该模块定义系统中人员与 AI Agent 的身份、参与记录和操作日志，支撑智能体调度与人员管理。由用户信息表（user）、用户演练参与记录表（user_training_record）、用户操作日志表（user_action_log）、智能体信息表（agent_info）和智能体工具映射表（agent_tool_mapping）组成，如图所示：

图3-4 用户与智能体参与E-R图
(1)用户信息表（user）
该表记录用户基本信息（用户名、邮箱、状态等），用于演练人员登录与权限管理
(2)用户演练参与记录表（user_training_record）
该表描述用户在每次演练中的身份角色、得分、参与时间等，用于回溯评估。
(3)用户操作日志表（user_action_log）
该表记录用户在平台上的关键操作行为（如配置修改、启动任务等），用于审计与行为分析。
(4)智能体信息表（agent_info）
该表定义系统中自动化智能体的标识与名称，用于执行攻击或防御任务。
(5)智能体工具映射表（agent_tool_mapping）
该表描述各类智能体与工具间的关联关系，包括用途、调用模板、激活状态等。
数据库表详情请见附录。
4.评估指标模块
该模块承载对人员与智能体的量化评估体系，支持场景化评分与指标驱动分析。由智能体评估指标表（agent_metric）、智能体评估记录表（agent_evaluation）、人员评估指标表（personnel_metric）和人员评估指标表（personnel_metric）组成，如图所示：

图3-5 评估指标E-R图
(1)智能体评估指标表（agent_metric）
该表定义针对智能体的各项评估指标（如执行成功率、反应速度等），包含维度、说明与计算公式。
(2)智能体评估记录表（agent_evaluation）
该表存储实际演练中对每个智能体在各指标上的评分结果与权重，支撑智能化评分系统。
(3)人员评估指标表（personnel_metric）
该表定义对人类操作者（红蓝队）的能力评估项（如响应时效、工具使用熟练度等）。
(4)人员评估指标表（personnel_metric）
该表记录每位人员在具体场景下的指标得分，用于综合能力评估与对比分析。
数据库表详情请见附录。

六、核心算法
本平台核心算法体系构建了一套智能化、模块化的攻防推演机制，涵盖攻击决策引擎、强化学习策略模块与动态场景生成系统三大关键部分，形成从“策略生成—攻击执行—效果验证—场景适配”的闭环流程。整体算法架构既体现了对实战攻防逻辑的深度建模，是实现智能化攻防推演与自动化网络安全评估的技术核心。
6.1攻防决策算法流程
在AI驱动的攻防演练平台中，攻防决策算法是核心智能模块，主要负责接收用户攻击指令、分析目标网络、制定策略并分阶段执行完整的攻击链条。该算法基于MITRE ATT\&CK框架七阶段模型构建（侦察、武器化、投递、利用、安装、命令控制、行动目标），并结合大语言模型（LLM）进行推理决策，使攻击过程具备高度智能性与真实感。
1. 指令接收与初始化
此阶段完成攻击任务的初始化并通知所有客户端攻击即将开始。攻击流程起始于中央控制Agent接收到攻击命令。系统通过FastAPI接口暴露命令处理端点，并初始化攻击状态：
@app.post("/process_command")
async def process_command(request: CommandRequest):
    attack_progress = []
    attack_status = "analyzing"
    logger.info(f"收到攻击指令，目标: {request.target_host}")
    await broadcast_progress(f"收到攻击指令，目标: {request.target_host}", "start")

2. 目标分析与策略制定
此步骤大幅提升了策略制定的自动化与个性化水平，避免人工预设攻击路径的局限。收到任务后，算法调用LLM模型对目标主机进行策略分析，自动生成攻击路径建议，包括入口点、漏洞类型、攻击方式及横向移动计划：
analysis_prompt = f"""
作为网络安全专家，请分析以下目标的可能攻击路径和策略:
目标主机: {request.target_host}
请考虑:
1. 最有效的攻击入口点
2. 可能的漏洞利用方式
3. 推荐的攻击类型（钓鱼、漏洞利用等）
4. 横向移动策略
"""
analysis_result = await llm.ainvoke(analysis_prompt)
analysis_text = analysis_result.content

3. 攻击执行与阶段调度
攻击执行由攻击智能体驱动，依据ATT\&CK模型完成以下七个阶段：
（1）侦察阶段（Reconnaissance）
系统可根据扫描结果确定最可能入侵的服务接口与协议。利用Nmap工具扫描目标主机开放端口和服务：
@tool
async def run_nmap(target_ip: str, options: str = "-T4 --top-ports 20") -> str:
    await attack_log_handler.log_tool_start("run_nmap", {"target_ip": target_ip})
    async with attack_service_client.client as client:
        response = await client.call_tool("run_nmap", arguments={"target_ip": target_ip})
    await attack_log_handler.log_tool_end("run_nmap", result)

（2）武器化阶段（Weaponization）
此阶段自动完成社会工程模板选择和Payload生成。根据目标漏洞环境定制恶意载荷，如构造钓鱼邮件或社会工程学媒介：
await send_standardized_log("info", "攻击智能体", "生成钓鱼邮件")
await send_standardized_log("success", "攻击智能体", "完成恶意载荷制作")

（3）投递阶段（Delivery）
同时记录用户是否接收恶意内容，为后续利用阶段做准备。攻击Agent通过电子邮件或文件传输方式向目标发起攻击：
await send_standardized_log("info", "攻击智能体", "发送钓鱼邮件")
await send_standardized_log("success", "攻击智能体", "钓鱼邮件投递成功")

（4）利用阶段（Exploitation）
攻击者在此阶段可通过提权脚本或漏洞利用套件取得系统控制权。监控目标行为，一旦触发执行载荷即完成漏洞利用：
await send_standardized_log("warning", "攻击智能体", "目标用户点击恶意链接")
await send_standardized_log("success", "攻击智能体", "获得主机访问权限")

（5）安装阶段（Installation）
该过程确保攻击者能在系统重启后继续控制目标。在目标系统中植入后门，建立持久化访问通道：
await send_standardized_log("info", "攻击智能体", "安装后门")
await send_standardized_log("success", "攻击智能体", "建立持久化访问")

（6）命令控制阶段（Command and Control）
此阶段是模拟APT攻击链中“潜伏渗透”的关键步骤。攻击者与目标主机建立C2通信通道，并尝试向内网横向移动：
await send_standardized_log("info", "攻击智能体", "建立C2通信")
await send_standardized_log("info", "攻击智能体", "横向移动至其他主机")

（7）行动目标阶段（Actions on Objectives）
完成所有攻击目标后，攻击Agent终止任务并汇总成果。最终执行攻击目的，如数据库窃取或系统破坏：
await send_standardized_log("warning", "攻击智能体", "窃取数据库数据")
await send_standardized_log("success", "攻击智能体", "成功控制目标系统")

4. 攻击进度监控与日志记录
攻击过程中的每一个步骤都将被结构化记录至日志系统，供蓝队溯源分析与防御优化使用。算法提供完整的过程可视化与日志服务，通过WebSocket实时将攻击状态广播至客户端：
async def broadcast_progress(message: str, progress_type: str = "info"):
    if "侦察" in message:
        prefix = "[侦察阶段] "
    # 省略其他阶段判断逻辑...
    for client in connected_clients:
        await client.send_json(progress_item)

6.2强化学习策略说明
为进一步提升平台在复杂网络环境下的攻击策略智能化能力，我们已成功引入强化学习（RL）机制，将其作为现有系统的智能增强组件。该模块通过在攻防演练过程中不断自我学习，实现策略生成的自适应与最优优化，显著提升了攻击模拟的真实性、效率与策略多样性。
1. 核心算法实现
本模块采用 [Stable-Baselines3](https://github.com/DLR-RM/stable-baselines3) 框架中的 PPO（Proximal Policy Optimization）算法作为主要策略学习方法，结合自定义环境 AttackSimulationEnv 进行训练与部署。主要实现如下：
# central_agent/main.py
from stable_baselines3 import PPO
from rl.env.attack_env import AttackSimulationEnv
class AttackStrategyRL:
    def __init__(self):
        self.model = PPO(
            "MlpPolicy",
            env=self._create_custom_env(),
            learning_rate=3e-4,
            n_steps=2048,
            batch_size=64,
            gamma=0.99,
            gae_lambda=0.95,
            clip_range=0.2,
            ent_coef=0.01,
            verbose=1
        )
        self.trained = False

    def _create_custom_env(self):
        return AttackSimulationEnv()

2. 自定义环境设计
平台已实现标准化的Gym兼容训练环境 AttackSimulationEnv，涵盖完整状态空间、动作空间及奖励函数逻辑，适配实战攻防链条：
class AttackSimulationEnv(gym.Env):
    def __init__(self):
        self.action_space = gym.spaces.Discrete(len(action_space))
        self.observation_space = gym.spaces.Box(
            low=0, high=1, shape=(len(state_features),), dtype=np.float32
        )
        self.state = self._reset()

    def _reset(self):
        return self._get_observation()

    def _step(self, action):
        attack_result = execute_attack(action)
        reward = calculate_reward(attack_result, self.state, action)
        done = attack_result['completed'] or attack_result['failed']
        self.state = self._get_observation()
        return self.state, reward, done, {}
状态空间与动作空间已根据网络安全语义建模完成，包括网络拓扑特征、目标价值、漏洞分布、安全策略等：
state_features = {
    'network_size': ..., 'vulnerability_scores': ...,
    'target_value': ..., 'resource_cost': ...,
    # 其余略
}

action_space = [
    'PHISHING_ATTACK', 'VULNERABILITY_EXPLOIT',
    'BRUTE_FORCE_ATTACK', 'LATERAL_MOVEMENT',
    'DATA_EXFILTRATION', ...
]
奖励函数设计结合攻击成功率、目标价值、资源效率与策略新颖性：
def calculate_reward(attack_result, state, action):
    base_reward = 100 if attack_result['success'] else -50
    target_value_reward = base_reward * state['target_value'] / 10
    resource_reward = 50 / (1.0 + state['resource_cost'])
    novelty_reward = 20 if action not in state['recent_actions'] else 0
    impact_penalty = 30 if attack_result['business_disruption'] > 0.5 else 0
    return target_value_reward + resource_reward + novelty_reward - impact_penalty
3.决策流程与系统调用
强化学习策略已集成进 process_command指令处理主流程中，在模型训练完成后，优先调用RL模型进行策略生成：
@app.post("/process_command")
async def process_command(request: CommandRequest):
    if rl_agent.trained:
        state = extract_state(request.target_host)
        action, _ = rl_agent.model.predict(state)
        selected_attack = action_space[action]
        await broadcast_progress(f"RL模型选择策略: {selected_attack}", "analyzing")
    else:
        selected_attack = await llm_analyze(request.target_host)
训练后，模型也具备在线学习能力，能够持续从真实演练数据中提取经验进行自我优化：
    if rl_agent.trained:
        reward = calculate_reward(attack_result, state, action)
        next_state = extract_state_from_result(attack_result)
        rl_agent.remember(state, action, reward, next_state, attack_result['completed'])
        rl_agent.train()
4.场景服务联动与优化策略
场景生成模块已完成与RL模块集成，支持在基础场景配置基础上进一步优化攻击路径、目标价值分布等关键参数：
def optimize_scenario(scenario_request):
    base_scenario = generate_dynamic_scenario(...)
    if rl_agent.trained:
        scenario_state = scenario_to_state(base_scenario)
        action, _ = rl_agent.model.predict(scenario_state)
        return apply_scenario_optimization(base_scenario, action)
    return base_scenario
6.3场景生成模型调用方式
场景生成模型通过结合业务场景和攻击类型，动态生成安全攻防演练场景。模型提供了多种调用方式，包括直接调用API接口、通过提示词分析自动生成场景等。
1.核心组件
（1）场景智能体（Scenario Agent）：位于agents/scenario_agent/main.py，提供场景生成的API接口和前端交互能力。
（2）场景服务（Scenario Service） ：位于services/scenario_service/main.py，基于FastMCP框架，负责实际的场景生成和容器部署工作。
2.主要接口及调用方式
（1）直接生成动态场景
通过调用  generate_dynamic_scenario  函数，传入业务场景和攻击类型，直接生成场景。
函数定义 ：
@tool
async def generate_dynamic_scenario(business_scenario: str, attack_type: str, custom_config: dict = None) -> str:
    # 函数实现...
参数说明 ：
business_scenario：业务场景类型，可选值为healthcare（医疗）、 finance（金融）、education  （教育）、manufacturing（制造）。
attack_type：攻击方式类型，可选值为apt（高级持续威胁）、phishing（钓鱼攻击）、  ransomware（勒索软件）、insider_threat（内部威胁）。
custom_config：自定义配置参数，用于覆盖默认配置，如环境变量、端口映射等。
调用示例 ：
import asyncio
from agents.scenario_agent.main import generate_dynamic_scenario
# 直接调用生成APT医疗场景
dynamic_scenario = asyncio.run(generate_dynamic_scenario(
    business_scenario="healthcare",
    attack_type="apt",
    custom_config={
        "environment_overrides": {
            "medical-server": {
                "DB_PASSWORD": "secure_password"
            }
        },
        "port_overrides": {
            "web-server": ["8080:80"]
        }
    }
))
（2）通过提示词分析生成场景
通过调用  analyze_user_prompt  函数，分析用户输入的自然语言提示词，自动提取业务场景和攻击类型，然后生成场景。
函数定义 ：
@tool
async def analyze_user_prompt(prompt: str) -> str:
    # 函数实现...
   参数说明 ：
prompt：用户输入的场景描述提示词，如"生成一个针对医院的APT攻击场景"。
 调用示例 ：
import asyncio
import json
from agents.scenario_agent.main import analyze_user_prompt, generate_dynamic_scenario
# 分析用户提示词
prompt_analysis = asyncio.run(analyze_user_prompt(
    prompt="生成一个针对金融机构的钓鱼攻击场景"
))
# 解析分析结果
analysis_result = json.loads(prompt_analysis)

business_scenario = analysis_result["business_scenario"]
attack_type = analysis_result["attack_type"]
# 使用分析结果生成场景
dynamic_scenario = asyncio.run(generate_dynamic_scenario(
    business_scenario=business_scenario,
    attack_type=attack_type
))
（3）解析现有场景文件
通过调用parse_apt_ready_scenario函数，解析已有的场景文件，提取拓扑结构信息。
    函数定义 ：
@tool
async def parse_apt_ready_scenario() -> str:
    # 函数实现...
  调用示例 ：
import asyncio
import json
from agents.scenario_agent.main import parse_apt_ready_scenario
# 解析apt-ready场景文件
topology_data = asyncio.run(parse_apt_ready_scenario())
# 提取拓扑信息用于前端渲染
topology = json.loads(topology_data)["topology"]
（4） 部署场景容器
通过调用deploy_scenario_containers函数，部署生成的场景容器。
函数定义 ：
@tool
async def deploy_scenario_containers(scenario_file: str) -> str:
    # 函数实现...
    参数说明 ：
scenario_file：Docker Compose场景文件路径。
    调用示例 ：
import asyncio
import json
from  agents.scenario_agent.main 
import  generate_dynamic_scenario, deploy_scenario_containers
# 生成场景
dynamic_scenario = asyncio.run(generate_dynamic_scenario(
    business_scenario="finance",
    attack_type="ransomware"
))
# 解析生成的场景文件路径
scenario_data = json.loads(dynamic_scenario)
scenario_file = scenario_data["compose_file"]
# 部署场景容器
deployment_result = asyncio.run(deploy_scenario_containers(scenario_file))
      
3.返回值说明
所有接口返回JSON格式字符串，包含以下主要字段：
status：操作状态，  success  表示成功，  error  表示失败。
message：操作结果描述。
scenario_name：生成的场景名称。
compose_file：生成的Docker Compose文件路径。
topology：场景拓扑结构信息，包含节点、网络和连接关系。
services_count：场景中包含的服务数量。
networks_count  ：场景中包含的网络数量。

4.调用流程示例
以下是完整的场景生成和部署流程示例：
import asyncio
import json
from agents.scenario_agent.main import analyze_user_prompt, generate_dynamic_scenario, deploy_scenario_containers

async def main():
    # 1. 分析用户提示词
    prompt = "生成一个针对制造企业的内部威胁场景"
    prompt_analysis = await analyze_user_prompt(prompt)
    analysis_result = json.loads(prompt_analysis)
    
    print(f"分析结果: {analysis_result}")
    
    # 2. 生成动态场景
    dynamic_scenario = await generate_dynamic_scenario(
        business_scenario=analysis_result["business_scenario"],
        attack_type=analysis_result["attack_type"],
        custom_config={
            "environment_overrides": {
                "file-server": {
                    "SENSITIVE_DATA": "true"
                }
            }
        }
    )
    
    scenario_data = json.loads(dynamic_scenario)
    print(f"场景生成结果: {scenario_data}")
    
    # 3. 部署场景容器
    if scenario_data["status"] == "success":
        deployment_result=await deploy_scenario_containers(scenario_data["compose_file"])
        print(f"容器部署结果: {deployment_result}")

if __name__ == "__main__":
    asyncio.run(main())
              

七、附录
1. 动态场景配置表（scene_config）
字段名	类型	约束	描述
scene_id	INT	PRIMARY KEY, AUTO_INCREMENT	场景唯一标识
name	VARCHAR(100)	NOT NULL, UNIQUE	场景名称
description	TEXT	NULL	场景描述
created_by	INT	FOREIGN KEY REFERENCES user(user_id)	创建者 ID（关联用户表）
created_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	创建时间
status	TINYINT	DEFAULT 1	场景状态（1 - 启用，0 - 停用）
2. 子场景任务表（scene_subtask）
字段名	类型	约束	描述
subtask_id	INT	PRIMARY KEY, AUTO_INCREMENT	子任务唯一标识
scene_id	INT	FOREIGN KEY REFERENCES scene_config(scene_id)	关联主场景 ID
name	VARCHAR(100)	NOT NULL	子任务名称（如 “数据库提权点”）
objective_type	VARCHAR(50)	NOT NULL	目标类型（RedFlagCapture/BlueDefense 等）
metric_codes	JSON	NOT NULL	关联指标代码列表（如 ["A1", "C2"]）
topology_ref	VARCHAR(100)	NULL	所属拓扑组件标识（IP / 节点 ID 等）
vulnerability_id	VARCHAR(50)	FOREIGN KEY REFERENCES vulnerability_info(vulnerability_id)	关联漏洞编号
importance_level	TINYINT	DEFAULT 1	重要等级（1-5）
enabled	BOOLEAN	DEFAULT TRUE	是否启用
config_detail	JSON	NULL	子任务补充参数（流量特征等）
created_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	创建时间
3. 网络拓扑表（network_topology）
字段名	类型	约束	描述
topology_id	INT	PRIMARY KEY, AUTO_INCREMENT	拓扑唯一标识
scene_id	INT	FOREIGN KEY REFERENCES scene_config(scene_id) NOT NULL	关联场景 ID
node_count	INT	NOT NULL	节点（主机 / 设备）数量
subnet_config	TEXT	NULL	子网 / VLAN 划分信息
link_relation	TEXT	NULL	节点链路关系（JSON 格式）
firewall_rules	TEXT	NULL	防火墙规则配置
4. 组件信息表（component_info）
字段名	类型	约束	描述
component_id	INT	PRIMARY KEY, AUTO_INCREMENT	组件唯一标识
scene_id	INT	FOREIGN KEY REFERENCES scene_config(scene_id) NOT NULL	关联场景 ID
component_type	VARCHAR(100)	NOT NULL	组件类型（如 “Web 服务”“MySQL 数据库”）
version	VARCHAR(50)	NULL	组件版本
port	INT	NULL	组件端口
vulnerability_id	INT	FOREIGN KEY REFERENCES vulnerability_info(vulnerability_id)	关联漏洞 ID
is_enabled	BOOLEAN	DEFAULT TRUE	是否启用
5. 漏洞信息表（vulnerability_info）
字段名	类型	约束	描述
vulnerability_id	INT	PRIMARY KEY, AUTO_INCREMENT	漏洞唯一标识
cve_number	VARCHAR(50)	UNIQUE	CVE 编号（如 “CVE-2021-44228”）
exploit_conditions	TEXT	NOT NULL	漏洞利用条件
impact_scope	VARCHAR(255)	NULL	影响范围（如 “Web 服务器”）
component_type	VARCHAR(100)	NOT NULL	适用组件类型
attack_path_id	INT	FOREIGN KEY REFERENCES attack_path(attack_path_id)	关联攻击路径 ID
6. 容器部署表（container_deploy）
字段名	类型	约束	描述
container_id	VARCHAR(100)	PRIMARY KEY	容器唯一标识（Docker 容器 ID）
scene_id	INT	FOREIGN KEY REFERENCES scene_config(scene_id) NOT NULL	关联场景 ID
image_name	VARCHAR(255)	NOT NULL	容器镜像名称
resource_config	VARCHAR(100)	NULL	资源配置参数（如 “CPU:2 核，内存：4G”）
network_address	VARCHAR(50)	NOT NULL	容器网络地址（IP: 端口）
deploy_time	DATETIME	NOT NULL	部署时间
status	TINYINT	NOT NULL, DEFAULT 1	容器状态（1 - 运行，0 - 停止）
7. 演练任务表（exercise_task）
字段名	类型	约束	描述
task_id	INT	PRIMARY KEY, AUTO_INCREMENT	演练任务唯一标识
scene_id	INT	NOT NULL, FOREIGN KEY REFERENCES scene_config(scene_id)	关联动态场景 ID
attacker_id	INT	NOT NULL, FOREIGN KEY	攻击方 ID（智能体 / 人员）
defender_id	INT	NOT NULL, FOREIGN KEY	防御方 ID（智能体 / 人员）
start_time	DATETIME	NOT NULL	演练开始时间
end_time	DATETIME	NULL	演练结束时间
status	VARCHAR(20)	DEFAULT 'pending'	状态（pending/running/finished）
score	FLOAT	NULL	自动评估得分
replay_url	TEXT	NULL	视频回放链接
8. 攻击行为日志表（attack_log）
字段名	类型	约束	描述
log_id	INT	PRIMARY KEY, AUTO_INCREMENT	日志唯一标识
task_id	INT	NOT NULL, FOREIGN KEY REFERENCES exercise_task(task_id)	所属演练任务 ID
agent_id	INT	NOT NULL, FOREIGN KEY REFERENCES agent_info(agent_id)	攻击 Agent ID
action_type	VARCHAR(50)	NOT NULL	攻击动作类型（扫描 / 利用 / 横向移动等）
target	VARCHAR(100)	NULL	攻击目标对象（IP / 服务名等）
timestamp	DATETIME	NOT NULL	行为发生时间
success	BOOLEAN	DEFAULT FALSE	是否成功
details	TEXT	NULL	详细说明（如利用 POC 路径）
9. 防御行为日志表（defense_log）
字段名	类型	约束	描述
log_id	INT	PRIMARY KEY, AUTO_INCREMENT	日志唯一标识
task_id	INT	NOT NULL, FOREIGN KEY REFERENCES exercise_task(task_id)	所属演练任务 ID
agent_id	INT	FOREIGN KEY REFERENCES agent_info(agent_id)	防御 Agent ID
action_type	VARCHAR(50)	NOT NULL	防御动作类型（封禁 IP / 日志分析等）
tool_name	VARCHAR(50)	NULL	使用的防御工具（如 Snort、Splunk）
target	VARCHAR(100)	NULL	防御目标（IP / 进程 / 资产等）
timestamp	DATETIME	NOT NULL	行为发生时间
result	TEXT	NULL	结果信息
10. 行为图谱节点表（behavior_graph_node）
字段名	类型	约束	描述
node_id	INT	PRIMARY KEY, AUTO_INCREMENT	节点唯一标识
task_id	INT	FOREIGN KEY REFERENCES exercise_task(task_id)	所属演练任务 ID
role	VARCHAR(20)	NOT NULL	所属角色（attacker/defender）
behavior_type	VARCHAR(50)	NOT NULL	行为类型（扫描 / 阻断 / 提权等）
timestamp	DATETIME	NOT NULL	行为时间
node_data	JSON	NULL	节点属性（设备、路径、结果等）
11. 行为路径表（behavior_path）
字段名	类型	约束	描述
path_id	INT	PRIMARY KEY, AUTO_INCREMENT	路径唯一标识
task_id	INT	NOT NULL, FOREIGN KEY REFERENCES exercise_task(task_id)	所属演练任务 ID
agent_id	INT	NOT NULL, FOREIGN KEY REFERENCES agent_info(agent_id)	Agent ID
role	VARCHAR(20)	NOT NULL	执行角色（attacker/defender）
start_node	INT	NOT NULL, FOREIGN KEY REFERENCES behavior_graph_node(node_id)	起始节点 ID
end_node	INT	NOT NULL, FOREIGN KEY REFERENCES behavior_graph_node(node_id)	终止节点 ID
success	BOOLEAN	DEFAULT FALSE	是否成功执行完整路径
summary	TEXT	NULL	路径描述（攻击链 / 响应链摘要）
12. 网络流量表（network_traffic）
字段名	类型	约束	描述
traffic_id	INT	PRIMARY KEY, AUTO_INCREMENT	唯一标识
src_ip	VARCHAR(50)	NOT NULL	源 IP 地址
dst_ip	VARCHAR(50)	NOT NULL	目标 IP 地址
src_port	INT	NULL	源端口
dst_port	INT	NULL	目标端口
protocol	VARCHAR(20)	NOT NULL	协议类型
payload_feature	TEXT	NULL	数据包特征
traffic_time	DATETIME	NOT NULL	流量记录时间
is_abnormal	TINYINT	DEFAULT 0	是否异常（0 - 正常，1 - 异常）
13. 用户操作日志表（user_action_log）
字段名	类型	约束	描述
log_id	INT	PRIMARY KEY, AUTO_INCREMENT	日志唯一标识
user_id	INT	NOT NULL, FOREIGN KEY REFERENCES user(user_id)	操作用户 ID
task_id	INT	FOREIGN KEY REFERENCES exercise_task(task_id)	所属演练任务 ID（可选）
action_type	VARCHAR(50)	NOT NULL	操作类型（配置修改 / 触发等）
target_object	VARCHAR(100)	NULL	操作目标（设备 / 配置项等）
details	TEXT	NULL	操作详细说明
created_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	操作时间
14. 用户信息表（user）
字段名	类型	约束	描述
user_id	INT	PRIMARY KEY, AUTO_INCREMENT	用户唯一标识
username	VARCHAR(50)	NOT NULL, UNIQUE	登录用户名
password_hash	VARCHAR(128)	NOT NULL	加密后的密码
email	VARCHAR(100)	UNIQUE	用户邮箱
status	VARCHAR(20)	DEFAULT 'active'	状态（active/inactive/locked）
created_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	账户创建时间
updated_at	DATETIME	DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP	最近修改时间
15. 用户演练参与记录表（user_training_record）
字段名	类型	约束	描述
record_id	INT	PRIMARY KEY, AUTO_INCREMENT	记录唯一标识
user_id	INT	NOT NULL, FOREIGN KEY REFERENCES user(user_id)	用户 ID
task_id	INT	NOT NULL, FOREIGN KEY REFERENCES exercise_task(task_id)	参与的演练任务 ID
role	VARCHAR(20)	NOT NULL	参与角色（attacker/defender）
score	FLOAT	NULL	最终评估得分
joined_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	参与时间
16. 智能体工具映射表（agent_tool_mapping）
字段名	类型	约束	描述
mapping_id	INT	PRIMARY KEY, AUTO_INCREMENT	映射关系唯一标识
agent_type	VARCHAR(50)	NOT NULL	智能体类型（攻击 / 防御 / 响应等）
function_type	VARCHAR(50)	NOT NULL	工具用途（探测 / 利用 / 修复等）
tool_name	VARCHAR(100)	NOT NULL	工具名称（如 nmap、MSF）
command_template	TEXT	NULL	命令模板（支持变量）
script_path	VARCHAR(255)	NULL	工具脚本路径
is_active	BOOLEAN	DEFAULT TRUE	是否启用
17. 智能体评估记录表（agent_evaluation）
字段名	类型	约束	描述
id	INT	PRIMARY KEY, AUTO_INCREMENT	评估记录唯一标识
agent_id	INT	NOT NULL	被评估智能体 ID
scene_id	INT	NOT NULL, FOREIGN KEY REFERENCES scene_config(scene_id)	关联演练场景
metric_code	VARCHAR(10)	NOT NULL	评估指标代码（如 A1、B3 等）
score	FLOAT	NOT NULL	指标得分
weight	FLOAT	NOT NULL	指标权重（动态调整）
evaluated_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	评估时间
18. 智能体信息表（agent_info）
字段名	类型	约束	描述
agent_id	BIGINT	PRIMARY KEY, AUTO_INCREMENT	智能体唯一标识 ID
agent_name	VARCHAR(64)	NOT NULL, UNIQUE	智能体名称（如场景智能体、攻击智能体）
19. 人员评估记录表（personnel_evaluation）
字段名	类型	约束	描述
id	INT	PRIMARY KEY, AUTO_INCREMENT	唯一标识
user_id	INT	NOT NULL, FOREIGN KEY REFERENCES user(user_id)	被评估人员 ID（蓝队 / 红队）
scene_id	INT	NOT NULL, FOREIGN KEY REFERENCES scene_config(scene_id)	所属演练场景 ID
metric_code	VARCHAR(10)	NOT NULL	指标代码（如 N、O、T 等）
score	FLOAT	NOT NULL	得分
weight	FLOAT	NOT NULL	权重
evaluated_at	DATETIME	DEFAULT CURRENT_TIMESTAMP	评估时间
20. 智能体评估指标表（agent_metric）
字段名	类型	约束	描述
metric_code	VARCHAR(10)	PRIMARY KEY	指标代码（如 A1、C3、K1 等）
name	VARCHAR(100)	NOT NULL	指标名称
dimension	VARCHAR(50)	NOT NULL	所属维度（A/B/C/...）
description	TEXT	NOT NULL	指标定义与说明
formula	TEXT	NULL	指标计算公式（含变量说明）
21. 人员评估指标表（personnel_metric）
字段名	类型	约束	描述
metric_code	VARCHAR(10)	PRIMARY KEY	指标代码（如 N、P、Z 等）
name	VARCHAR(100)	NOT NULL	指标名称
description	TEXT	NOT NULL	指标定义与说明
formula	TEXT	NULL	指标计算公式（含变量定义）
