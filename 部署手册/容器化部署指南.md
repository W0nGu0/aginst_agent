# Kubernetes容器化部署指南

本文档提供基于Kubernetes的AI Agent攻防推演平台容器化部署方案，实现高可用、可扩展的生产级部署。

## 📋 容器化架构概览

### 🏗️ Kubernetes集群架构
```
┌─────────────────────────────────────────────────────────┐
│                   Kubernetes集群                        │
├─────────────────────────────────────────────────────────┤
│  Ingress Controller (Nginx)                            │
│  ├── sec-agent.example.com                             │
│  └── api.sec-agent.example.com                         │
├─────────────────────────────────────────────────────────┤
│  Frontend Namespace                                     │
│  ├── Frontend Deployment (3 replicas)                  │
│  └── Frontend Service (ClusterIP)                      │
├─────────────────────────────────────────────────────────┤
│  Backend Namespace                                      │
│  ├── Backend API Deployment (3 replicas)               │
│  ├── Central Agent Deployment (2 replicas)             │
│  └── Backend Services                                   │
├─────────────────────────────────────────────────────────┤
│  AI Agents Namespace                                    │
│  ├── Scenario Agent Deployment (2 replicas)            │
│  ├── Attack Agent Deployment (2 replicas)              │
│  ├── Defense Agents Deployment (3 replicas)            │
│  ├── Evaluate Agent Deployment (2 replicas)            │
│  └── Victim Host Agent Deployment (1 replica)          │
├─────────────────────────────────────────────────────────┤
│  MCP Services Namespace                                 │
│  ├── Scenario Service Deployment (2 replicas)          │
│  ├── Attack Service Deployment (2 replicas)            │
│  ├── Defense Services Deployment (3 replicas)          │
│  └── Evaluate Service Deployment (2 replicas)          │
├─────────────────────────────────────────────────────────┤
│  Data Namespace                                         │
│  ├── PostgreSQL StatefulSet (3 replicas)               │
│  ├── Redis Cluster (6 replicas)                        │
│  └── Persistent Volumes                                 │
└─────────────────────────────────────────────────────────┘
```

## 🔧 环境要求

### Kubernetes集群要求
- **Kubernetes版本**: 1.24+
- **节点数量**: 最少3个节点 (推荐5个节点)
- **每节点配置**: 
  - CPU: 4核心以上
  - 内存: 8GB以上
  - 存储: 100GB以上

### 必需组件
- **Container Runtime**: Docker 20.10+ 或 containerd 1.6+
- **Ingress Controller**: Nginx Ingress Controller
- **Storage Class**: 支持动态存储分配
- **Load Balancer**: MetalLB 或云厂商LB

## 📦 Docker镜像构建

### 1. 创建Dockerfile

#### Frontend Dockerfile
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### Backend API Dockerfile
```dockerfile
# backend/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建非root用户
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8080
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
```

#### AI Agent Dockerfile模板
```dockerfile
# agents/*/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY . .

# 创建用户
RUN useradd -m -u 1000 agentuser && chown -R agentuser:agentuser /app
USER agentuser

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2. 构建脚本

创建 `build-images.sh`:
```bash
#!/bin/bash

# 设置镜像仓库
REGISTRY="your-registry.com/sec-agent"
VERSION="v1.0.0"

echo "🐳 构建AI Agent攻防推演平台Docker镜像..."

# 构建前端镜像
echo "📱 构建前端镜像..."
docker build -t ${REGISTRY}/frontend:${VERSION} .
docker build -t ${REGISTRY}/frontend:latest .

# 构建后端镜像
echo "🔧 构建后端镜像..."
docker build -t ${REGISTRY}/backend:${VERSION} ./backend
docker build -t ${REGISTRY}/backend:latest ./backend

# 构建AI Agent镜像
agents=("scenario_agent" "attack_agent" "central_agent" "evaluate_agent" "victim_host_agent")
for agent in "${agents[@]}"; do
    echo "🤖 构建${agent}镜像..."
    docker build -t ${REGISTRY}/${agent}:${VERSION} ./agents/${agent}
    docker build -t ${REGISTRY}/${agent}:latest ./agents/${agent}
done

# 构建MCP服务镜像
services=("scenario_service" "attack_service" "evaluate_service")
for service in "${services[@]}"; do
    echo "🔧 构建${service}镜像..."
    docker build -t ${REGISTRY}/${service}:${VERSION} ./services/${service}
    docker build -t ${REGISTRY}/${service}:latest ./services/${service}
done

echo "✅ 所有镜像构建完成!"

# 推送镜像到仓库
read -p "是否推送镜像到仓库? (y/n): " push_images
if [[ $push_images =~ ^[Yy]$ ]]; then
    echo "📤 推送镜像到仓库..."
    docker push ${REGISTRY}/frontend:${VERSION}
    docker push ${REGISTRY}/frontend:latest
    docker push ${REGISTRY}/backend:${VERSION}
    docker push ${REGISTRY}/backend:latest
    
    for agent in "${agents[@]}"; do
        docker push ${REGISTRY}/${agent}:${VERSION}
        docker push ${REGISTRY}/${agent}:latest
    done
    
    for service in "${services[@]}"; do
        docker push ${REGISTRY}/${service}:${VERSION}
        docker push ${REGISTRY}/${service}:latest
    done
    
    echo "✅ 镜像推送完成!"
fi
```

## 🚀 Kubernetes部署配置

### 1. 命名空间配置

创建 `k8s/namespaces.yaml`:
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-frontend
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: frontend
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-backend
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: backend
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-agents
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: ai-agents
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-services
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: mcp-services
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-data
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: data
```

### 2. ConfigMap配置

创建 `k8s/configmaps.yaml`:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sec-agent-config
  namespace: sec-agent-backend
data:
  DEBUG: "False"
  LOG_LEVEL: "INFO"
  CORS_ORIGINS: "https://sec-agent.example.com"
  DATABASE_URL: "postgresql://sec_agent:password@postgres:5432/sec_agent"
  REDIS_URL: "redis://redis:6379/0"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: sec-agent-frontend
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 1024;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        sendfile on;
        keepalive_timeout 65;
        
        gzip on;
        gzip_types text/plain text/css application/json application/javascript;
        
        server {
            listen 80;
            server_name _;
            
            location / {
                root /usr/share/nginx/html;
                try_files $uri $uri/ /index.html;
            }
            
            location /api/ {
                proxy_pass http://backend-service.sec-agent-backend.svc.cluster.local:8080/api/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
        }
    }
```

### 3. Secret配置

创建 `k8s/secrets.yaml`:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: sec-agent-secrets
  namespace: sec-agent-agents
type: Opaque
data:
  # Base64编码的API密钥
  DEEPSEEK_API_KEY: c2stWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWA==
---
apiVersion: v1
kind: Secret
metadata:
  name: database-secrets
  namespace: sec-agent-data
type: Opaque
data:
  POSTGRES_PASSWORD: cGFzc3dvcmQ=
  POSTGRES_USER: c2VjX2FnZW50
  POSTGRES_DB: c2VjX2FnZW50
```

### 4. 前端部署

创建 `k8s/frontend-deployment.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: sec-agent-frontend
  labels:
    app: frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: your-registry.com/sec-agent/frontend:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: sec-agent-frontend
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

### 5. 后端API部署

创建 `k8s/backend-deployment.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: sec-agent-backend
  labels:
    app: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: your-registry.com/sec-agent/backend:latest
        ports:
        - containerPort: 8080
        env:
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: DEBUG
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: LOG_LEVEL
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: REDIS_URL
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: sec-agent-backend
spec:
  selector:
    app: backend
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP

### 6. AI智能代理部署

创建 `k8s/ai-agents-deployment.yaml`:
```yaml
# 场景智能体
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scenario-agent
  namespace: sec-agent-agents
  labels:
    app: scenario-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: scenario-agent
  template:
    metadata:
      labels:
        app: scenario-agent
    spec:
      containers:
      - name: scenario-agent
        image: your-registry.com/sec-agent/scenario_agent:latest
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: sec-agent-secrets
              key: DEEPSEEK_API_KEY
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: scenario-agent-service
  namespace: sec-agent-agents
spec:
  selector:
    app: scenario-agent
  ports:
  - port: 8007
    targetPort: 8000
  type: ClusterIP
---
# 攻击智能体
apiVersion: apps/v1
kind: Deployment
metadata:
  name: attack-agent
  namespace: sec-agent-agents
  labels:
    app: attack-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: attack-agent
  template:
    metadata:
      labels:
        app: attack-agent
    spec:
      containers:
      - name: attack-agent
        image: your-registry.com/sec-agent/attack_agent:latest
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: sec-agent-secrets
              key: DEEPSEEK_API_KEY
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: attack-agent-service
  namespace: sec-agent-agents
spec:
  selector:
    app: attack-agent
  ports:
  - port: 8004
    targetPort: 8000
  type: ClusterIP
---
# 评估智能体
apiVersion: apps/v1
kind: Deployment
metadata:
  name: evaluate-agent
  namespace: sec-agent-agents
  labels:
    app: evaluate-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: evaluate-agent
  template:
    metadata:
      labels:
        app: evaluate-agent
    spec:
      containers:
      - name: evaluate-agent
        image: your-registry.com/sec-agent/evaluate_agent:latest
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: sec-agent-secrets
              key: DEEPSEEK_API_KEY
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: evaluate-agent-service
  namespace: sec-agent-agents
spec:
  selector:
    app: evaluate-agent
  ports:
  - port: 8014
    targetPort: 8000
  type: ClusterIP
```

### 7. MCP微服务部署

创建 `k8s/mcp-services-deployment.yaml`:
```yaml
# 场景服务
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scenario-service
  namespace: sec-agent-services
  labels:
    app: scenario-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: scenario-service
  template:
    metadata:
      labels:
        app: scenario-service
    spec:
      containers:
      - name: scenario-service
        image: your-registry.com/sec-agent/scenario_service:latest
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "256Mi"
            cpu: "150m"
          limits:
            memory: "512Mi"
            cpu: "300m"
        livenessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: scenario-service
  namespace: sec-agent-services
spec:
  selector:
    app: scenario-service
  ports:
  - port: 8002
    targetPort: 8000
  type: ClusterIP
---
# 攻击服务
apiVersion: apps/v1
kind: Deployment
metadata:
  name: attack-service
  namespace: sec-agent-services
  labels:
    app: attack-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: attack-service
  template:
    metadata:
      labels:
        app: attack-service
    spec:
      containers:
      - name: attack-service
        image: your-registry.com/sec-agent/attack_service:latest
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "256Mi"
            cpu: "150m"
          limits:
            memory: "512Mi"
            cpu: "300m"
        livenessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: attack-service
  namespace: sec-agent-services
spec:
  selector:
    app: attack-service
  ports:
  - port: 8001
    targetPort: 8000
  type: ClusterIP

### 8. 数据层部署

创建 `k8s/data-layer.yaml`:
```yaml
# PostgreSQL StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: sec-agent-data
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: POSTGRES_DB
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: sec-agent-data
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
  type: ClusterIP
---
# Redis Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: sec-agent-data
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        command: ["redis-server"]
        args: ["--appendonly", "yes"]
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: sec-agent-data
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: sec-agent-data
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
  type: ClusterIP
```

### 9. Ingress配置

创建 `k8s/ingress.yaml`:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sec-agent-ingress
  namespace: sec-agent-frontend
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - sec-agent.example.com
    - api.sec-agent.example.com
    secretName: sec-agent-tls
  rules:
  - host: sec-agent.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  - host: api.sec-agent.example.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8080
      - path: /agents/scenario(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: scenario-agent-service
            port:
              number: 8007
      - path: /agents/attack(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: attack-agent-service
            port:
              number: 8004
      - path: /agents/evaluate(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: evaluate-agent-service
            port:
              number: 8014
      - path: /services/scenario(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: scenario-service
            port:
              number: 8002
      - path: /services/attack(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: attack-service
            port:
              number: 8001

## 🚀 部署流程

### 1. 准备工作

#### 创建部署目录
```bash
mkdir -p k8s-deployment
cd k8s-deployment

# 创建子目录
mkdir -p {base,overlays/dev,overlays/prod}
```

#### 设置镜像仓库
```bash
# 登录镜像仓库
docker login your-registry.com

# 设置环境变量
export REGISTRY="your-registry.com/sec-agent"
export VERSION="v1.0.0"
```

### 2. 构建和推送镜像

```bash
# 执行构建脚本
chmod +x build-images.sh
./build-images.sh

# 验证镜像
docker images | grep sec-agent
```

### 3. 部署到Kubernetes

#### 创建命名空间
```bash
kubectl apply -f k8s/namespaces.yaml
```

#### 创建Secrets
```bash
# 创建API密钥Secret
kubectl create secret generic sec-agent-secrets \
  --from-literal=DEEPSEEK_API_KEY=your-api-key-here \
  -n sec-agent-agents

# 创建数据库Secret
kubectl create secret generic database-secrets \
  --from-literal=POSTGRES_USER=sec_agent \
  --from-literal=POSTGRES_PASSWORD=your-password \
  --from-literal=POSTGRES_DB=sec_agent \
  -n sec-agent-data
```

#### 部署数据层
```bash
kubectl apply -f k8s/data-layer.yaml
```

#### 部署应用层
```bash
# 部署MCP服务
kubectl apply -f k8s/mcp-services-deployment.yaml

# 部署AI智能代理
kubectl apply -f k8s/ai-agents-deployment.yaml

# 部署后端API
kubectl apply -f k8s/backend-deployment.yaml

# 部署前端
kubectl apply -f k8s/frontend-deployment.yaml
```

#### 配置Ingress
```bash
kubectl apply -f k8s/ingress.yaml
```

### 4. 验证部署

#### 检查Pod状态
```bash
# 检查所有命名空间的Pod
kubectl get pods --all-namespaces | grep sec-agent

# 检查特定命名空间
kubectl get pods -n sec-agent-frontend
kubectl get pods -n sec-agent-backend
kubectl get pods -n sec-agent-agents
kubectl get pods -n sec-agent-services
kubectl get pods -n sec-agent-data
```

#### 检查服务状态
```bash
# 检查服务
kubectl get svc --all-namespaces | grep sec-agent

# 检查Ingress
kubectl get ingress -n sec-agent-frontend
```

#### 查看日志
```bash
# 查看后端日志
kubectl logs -f deployment/backend -n sec-agent-backend

# 查看场景智能体日志
kubectl logs -f deployment/scenario-agent -n sec-agent-agents
```

## 🔧 运维管理

### 1. 扩缩容管理

#### 手动扩缩容
```bash
# 扩展后端副本数
kubectl scale deployment backend --replicas=5 -n sec-agent-backend

# 扩展AI智能代理
kubectl scale deployment scenario-agent --replicas=3 -n sec-agent-agents
```

#### 自动扩缩容 (HPA)
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: sec-agent-backend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 2. 滚动更新

```bash
# 更新镜像
kubectl set image deployment/backend backend=your-registry.com/sec-agent/backend:v1.1.0 -n sec-agent-backend

# 查看更新状态
kubectl rollout status deployment/backend -n sec-agent-backend

# 回滚更新
kubectl rollout undo deployment/backend -n sec-agent-backend
```

### 3. 监控和日志

#### Prometheus监控配置
```yaml
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: sec-agent-monitor
  namespace: sec-agent-backend
spec:
  selector:
    matchLabels:
      app: backend
  endpoints:
  - port: metrics
    path: /metrics
```

#### 日志收集配置
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: kube-system
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/sec-agent*.log
      pos_file /var/log/fluentd-sec-agent.log.pos
      tag kubernetes.sec-agent
      format json
    </source>

    <match kubernetes.sec-agent>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      index_name sec-agent
    </match>
```

## 🔐 安全配置

### 1. 网络策略

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sec-agent-network-policy
  namespace: sec-agent-backend
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: sec-agent-frontend
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: sec-agent-data
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 6379
```

### 2. Pod安全策略

```yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: sec-agent-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

## 📋 故障排除

### 常见问题

#### 1. Pod启动失败
```bash
# 查看Pod详情
kubectl describe pod <pod-name> -n <namespace>

# 查看事件
kubectl get events -n <namespace> --sort-by='.lastTimestamp'
```

#### 2. 服务无法访问
```bash
# 检查服务端点
kubectl get endpoints -n <namespace>

# 测试服务连通性
kubectl run test-pod --image=busybox -it --rm -- /bin/sh
# 在Pod内执行: wget -qO- http://service-name:port
```

#### 3. 存储问题
```bash
# 检查PV和PVC状态
kubectl get pv,pvc --all-namespaces

# 查看存储类
kubectl get storageclass
```

## 🎯 性能优化

### 1. 资源配置优化
- 根据实际负载调整CPU和内存限制
- 使用节点亲和性优化Pod调度
- 配置合适的副本数量

### 2. 网络优化
- 使用Service Mesh (如Istio) 优化服务间通信
- 配置合适的负载均衡策略
- 启用HTTP/2和gRPC

### 3. 存储优化
- 使用SSD存储类提升I/O性能
- 配置数据库连接池
- 实施数据分片和读写分离

---

**版本**: v1.0.0
**更新日期**: 2024年12月
**维护团队**: AI Agent攻防推演平台开发团队

通过本指南，您可以在Kubernetes集群中成功部署高可用、可扩展的AI Agent攻防推演平台。
```
```
```
