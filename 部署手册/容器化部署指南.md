# Kuberneteså®¹å™¨åŒ–éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›åŸºäºKubernetesçš„AI Agentæ”»é˜²æ¨æ¼”å¹³å°å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆï¼Œå®ç°é«˜å¯ç”¨ã€å¯æ‰©å±•çš„ç”Ÿäº§çº§éƒ¨ç½²ã€‚

## ğŸ“‹ å®¹å™¨åŒ–æ¶æ„æ¦‚è§ˆ

### ğŸ—ï¸ Kubernetesé›†ç¾¤æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Kubernetesé›†ç¾¤                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ingress Controller (Nginx)                            â”‚
â”‚  â”œâ”€â”€ sec-agent.example.com                             â”‚
â”‚  â””â”€â”€ api.sec-agent.example.com                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Frontend Namespace                                     â”‚
â”‚  â”œâ”€â”€ Frontend Deployment (3 replicas)                  â”‚
â”‚  â””â”€â”€ Frontend Service (ClusterIP)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Backend Namespace                                      â”‚
â”‚  â”œâ”€â”€ Backend API Deployment (3 replicas)               â”‚
â”‚  â”œâ”€â”€ Central Agent Deployment (2 replicas)             â”‚
â”‚  â””â”€â”€ Backend Services                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI Agents Namespace                                    â”‚
â”‚  â”œâ”€â”€ Scenario Agent Deployment (2 replicas)            â”‚
â”‚  â”œâ”€â”€ Attack Agent Deployment (2 replicas)              â”‚
â”‚  â”œâ”€â”€ Defense Agents Deployment (3 replicas)            â”‚
â”‚  â”œâ”€â”€ Evaluate Agent Deployment (2 replicas)            â”‚
â”‚  â””â”€â”€ Victim Host Agent Deployment (1 replica)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MCP Services Namespace                                 â”‚
â”‚  â”œâ”€â”€ Scenario Service Deployment (2 replicas)          â”‚
â”‚  â”œâ”€â”€ Attack Service Deployment (2 replicas)            â”‚
â”‚  â”œâ”€â”€ Defense Services Deployment (3 replicas)          â”‚
â”‚  â””â”€â”€ Evaluate Service Deployment (2 replicas)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Namespace                                         â”‚
â”‚  â”œâ”€â”€ PostgreSQL StatefulSet (3 replicas)               â”‚
â”‚  â”œâ”€â”€ Redis Cluster (6 replicas)                        â”‚
â”‚  â””â”€â”€ Persistent Volumes                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### Kubernetesé›†ç¾¤è¦æ±‚
- **Kubernetesç‰ˆæœ¬**: 1.24+
- **èŠ‚ç‚¹æ•°é‡**: æœ€å°‘3ä¸ªèŠ‚ç‚¹ (æ¨è5ä¸ªèŠ‚ç‚¹)
- **æ¯èŠ‚ç‚¹é…ç½®**: 
  - CPU: 4æ ¸å¿ƒä»¥ä¸Š
  - å†…å­˜: 8GBä»¥ä¸Š
  - å­˜å‚¨: 100GBä»¥ä¸Š

### å¿…éœ€ç»„ä»¶
- **Container Runtime**: Docker 20.10+ æˆ– containerd 1.6+
- **Ingress Controller**: Nginx Ingress Controller
- **Storage Class**: æ”¯æŒåŠ¨æ€å­˜å‚¨åˆ†é…
- **Load Balancer**: MetalLB æˆ–äº‘å‚å•†LB

## ğŸ“¦ Dockeré•œåƒæ„å»º

### 1. åˆ›å»ºDockerfile

#### Frontend Dockerfile
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### Backend API Dockerfile
```dockerfile
# backend/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8080
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
```

#### AI Agent Dockerfileæ¨¡æ¿
```dockerfile
# agents/*/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# åˆ›å»ºç”¨æˆ·
RUN useradd -m -u 1000 agentuser && chown -R agentuser:agentuser /app
USER agentuser

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2. æ„å»ºè„šæœ¬

åˆ›å»º `build-images.sh`:
```bash
#!/bin/bash

# è®¾ç½®é•œåƒä»“åº“
REGISTRY="your-registry.com/sec-agent"
VERSION="v1.0.0"

echo "ğŸ³ æ„å»ºAI Agentæ”»é˜²æ¨æ¼”å¹³å°Dockeré•œåƒ..."

# æ„å»ºå‰ç«¯é•œåƒ
echo "ğŸ“± æ„å»ºå‰ç«¯é•œåƒ..."
docker build -t ${REGISTRY}/frontend:${VERSION} .
docker build -t ${REGISTRY}/frontend:latest .

# æ„å»ºåç«¯é•œåƒ
echo "ğŸ”§ æ„å»ºåç«¯é•œåƒ..."
docker build -t ${REGISTRY}/backend:${VERSION} ./backend
docker build -t ${REGISTRY}/backend:latest ./backend

# æ„å»ºAI Agenté•œåƒ
agents=("scenario_agent" "attack_agent" "central_agent" "evaluate_agent" "victim_host_agent")
for agent in "${agents[@]}"; do
    echo "ğŸ¤– æ„å»º${agent}é•œåƒ..."
    docker build -t ${REGISTRY}/${agent}:${VERSION} ./agents/${agent}
    docker build -t ${REGISTRY}/${agent}:latest ./agents/${agent}
done

# æ„å»ºMCPæœåŠ¡é•œåƒ
services=("scenario_service" "attack_service" "evaluate_service")
for service in "${services[@]}"; do
    echo "ğŸ”§ æ„å»º${service}é•œåƒ..."
    docker build -t ${REGISTRY}/${service}:${VERSION} ./services/${service}
    docker build -t ${REGISTRY}/${service}:latest ./services/${service}
done

echo "âœ… æ‰€æœ‰é•œåƒæ„å»ºå®Œæˆ!"

# æ¨é€é•œåƒåˆ°ä»“åº“
read -p "æ˜¯å¦æ¨é€é•œåƒåˆ°ä»“åº“? (y/n): " push_images
if [[ $push_images =~ ^[Yy]$ ]]; then
    echo "ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“..."
    docker push ${REGISTRY}/frontend:${VERSION}
    docker push ${REGISTRY}/frontend:latest
    docker push ${REGISTRY}/backend:${VERSION}
    docker push ${REGISTRY}/backend:latest
    
    for agent in "${agents[@]}"; do
        docker push ${REGISTRY}/${agent}:${VERSION}
        docker push ${REGISTRY}/${agent}:latest
    done
    
    for service in "${services[@]}"; do
        docker push ${REGISTRY}/${service}:${VERSION}
        docker push ${REGISTRY}/${service}:latest
    done
    
    echo "âœ… é•œåƒæ¨é€å®Œæˆ!"
fi
```

## ğŸš€ Kuberneteséƒ¨ç½²é…ç½®

### 1. å‘½åç©ºé—´é…ç½®

åˆ›å»º `k8s/namespaces.yaml`:
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-frontend
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: frontend
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-backend
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: backend
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-agents
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: ai-agents
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-services
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: mcp-services
---
apiVersion: v1
kind: Namespace
metadata:
  name: sec-agent-data
  labels:
    app.kubernetes.io/name: sec-agent
    app.kubernetes.io/component: data
```

### 2. ConfigMapé…ç½®

åˆ›å»º `k8s/configmaps.yaml`:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sec-agent-config
  namespace: sec-agent-backend
data:
  DEBUG: "False"
  LOG_LEVEL: "INFO"
  CORS_ORIGINS: "https://sec-agent.example.com"
  DATABASE_URL: "postgresql://sec_agent:password@postgres:5432/sec_agent"
  REDIS_URL: "redis://redis:6379/0"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: sec-agent-frontend
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 1024;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        sendfile on;
        keepalive_timeout 65;
        
        gzip on;
        gzip_types text/plain text/css application/json application/javascript;
        
        server {
            listen 80;
            server_name _;
            
            location / {
                root /usr/share/nginx/html;
                try_files $uri $uri/ /index.html;
            }
            
            location /api/ {
                proxy_pass http://backend-service.sec-agent-backend.svc.cluster.local:8080/api/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
        }
    }
```

### 3. Secreté…ç½®

åˆ›å»º `k8s/secrets.yaml`:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: sec-agent-secrets
  namespace: sec-agent-agents
type: Opaque
data:
  # Base64ç¼–ç çš„APIå¯†é’¥
  DEEPSEEK_API_KEY: c2stWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWA==
---
apiVersion: v1
kind: Secret
metadata:
  name: database-secrets
  namespace: sec-agent-data
type: Opaque
data:
  POSTGRES_PASSWORD: cGFzc3dvcmQ=
  POSTGRES_USER: c2VjX2FnZW50
  POSTGRES_DB: c2VjX2FnZW50
```

### 4. å‰ç«¯éƒ¨ç½²

åˆ›å»º `k8s/frontend-deployment.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: sec-agent-frontend
  labels:
    app: frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: your-registry.com/sec-agent/frontend:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: sec-agent-frontend
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

### 5. åç«¯APIéƒ¨ç½²

åˆ›å»º `k8s/backend-deployment.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: sec-agent-backend
  labels:
    app: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: your-registry.com/sec-agent/backend:latest
        ports:
        - containerPort: 8080
        env:
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: DEBUG
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: LOG_LEVEL
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: sec-agent-config
              key: REDIS_URL
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: sec-agent-backend
spec:
  selector:
    app: backend
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP

### 6. AIæ™ºèƒ½ä»£ç†éƒ¨ç½²

åˆ›å»º `k8s/ai-agents-deployment.yaml`:
```yaml
# åœºæ™¯æ™ºèƒ½ä½“
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scenario-agent
  namespace: sec-agent-agents
  labels:
    app: scenario-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: scenario-agent
  template:
    metadata:
      labels:
        app: scenario-agent
    spec:
      containers:
      - name: scenario-agent
        image: your-registry.com/sec-agent/scenario_agent:latest
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: sec-agent-secrets
              key: DEEPSEEK_API_KEY
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: scenario-agent-service
  namespace: sec-agent-agents
spec:
  selector:
    app: scenario-agent
  ports:
  - port: 8007
    targetPort: 8000
  type: ClusterIP
---
# æ”»å‡»æ™ºèƒ½ä½“
apiVersion: apps/v1
kind: Deployment
metadata:
  name: attack-agent
  namespace: sec-agent-agents
  labels:
    app: attack-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: attack-agent
  template:
    metadata:
      labels:
        app: attack-agent
    spec:
      containers:
      - name: attack-agent
        image: your-registry.com/sec-agent/attack_agent:latest
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: sec-agent-secrets
              key: DEEPSEEK_API_KEY
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: attack-agent-service
  namespace: sec-agent-agents
spec:
  selector:
    app: attack-agent
  ports:
  - port: 8004
    targetPort: 8000
  type: ClusterIP
---
# è¯„ä¼°æ™ºèƒ½ä½“
apiVersion: apps/v1
kind: Deployment
metadata:
  name: evaluate-agent
  namespace: sec-agent-agents
  labels:
    app: evaluate-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: evaluate-agent
  template:
    metadata:
      labels:
        app: evaluate-agent
    spec:
      containers:
      - name: evaluate-agent
        image: your-registry.com/sec-agent/evaluate_agent:latest
        ports:
        - containerPort: 8000
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: sec-agent-secrets
              key: DEEPSEEK_API_KEY
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: evaluate-agent-service
  namespace: sec-agent-agents
spec:
  selector:
    app: evaluate-agent
  ports:
  - port: 8014
    targetPort: 8000
  type: ClusterIP
```

### 7. MCPå¾®æœåŠ¡éƒ¨ç½²

åˆ›å»º `k8s/mcp-services-deployment.yaml`:
```yaml
# åœºæ™¯æœåŠ¡
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scenario-service
  namespace: sec-agent-services
  labels:
    app: scenario-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: scenario-service
  template:
    metadata:
      labels:
        app: scenario-service
    spec:
      containers:
      - name: scenario-service
        image: your-registry.com/sec-agent/scenario_service:latest
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "256Mi"
            cpu: "150m"
          limits:
            memory: "512Mi"
            cpu: "300m"
        livenessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: scenario-service
  namespace: sec-agent-services
spec:
  selector:
    app: scenario-service
  ports:
  - port: 8002
    targetPort: 8000
  type: ClusterIP
---
# æ”»å‡»æœåŠ¡
apiVersion: apps/v1
kind: Deployment
metadata:
  name: attack-service
  namespace: sec-agent-services
  labels:
    app: attack-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: attack-service
  template:
    metadata:
      labels:
        app: attack-service
    spec:
      containers:
      - name: attack-service
        image: your-registry.com/sec-agent/attack_service:latest
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        resources:
          requests:
            memory: "256Mi"
            cpu: "150m"
          limits:
            memory: "512Mi"
            cpu: "300m"
        livenessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /mcp/
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: attack-service
  namespace: sec-agent-services
spec:
  selector:
    app: attack-service
  ports:
  - port: 8001
    targetPort: 8000
  type: ClusterIP

### 8. æ•°æ®å±‚éƒ¨ç½²

åˆ›å»º `k8s/data-layer.yaml`:
```yaml
# PostgreSQL StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: sec-agent-data
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: POSTGRES_DB
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: sec-agent-data
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
  type: ClusterIP
---
# Redis Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: sec-agent-data
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        command: ["redis-server"]
        args: ["--appendonly", "yes"]
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: sec-agent-data
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: sec-agent-data
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
  type: ClusterIP
```

### 9. Ingressé…ç½®

åˆ›å»º `k8s/ingress.yaml`:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sec-agent-ingress
  namespace: sec-agent-frontend
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - sec-agent.example.com
    - api.sec-agent.example.com
    secretName: sec-agent-tls
  rules:
  - host: sec-agent.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  - host: api.sec-agent.example.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8080
      - path: /agents/scenario(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: scenario-agent-service
            port:
              number: 8007
      - path: /agents/attack(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: attack-agent-service
            port:
              number: 8004
      - path: /agents/evaluate(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: evaluate-agent-service
            port:
              number: 8014
      - path: /services/scenario(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: scenario-service
            port:
              number: 8002
      - path: /services/attack(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: attack-service
            port:
              number: 8001

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. å‡†å¤‡å·¥ä½œ

#### åˆ›å»ºéƒ¨ç½²ç›®å½•
```bash
mkdir -p k8s-deployment
cd k8s-deployment

# åˆ›å»ºå­ç›®å½•
mkdir -p {base,overlays/dev,overlays/prod}
```

#### è®¾ç½®é•œåƒä»“åº“
```bash
# ç™»å½•é•œåƒä»“åº“
docker login your-registry.com

# è®¾ç½®ç¯å¢ƒå˜é‡
export REGISTRY="your-registry.com/sec-agent"
export VERSION="v1.0.0"
```

### 2. æ„å»ºå’Œæ¨é€é•œåƒ

```bash
# æ‰§è¡Œæ„å»ºè„šæœ¬
chmod +x build-images.sh
./build-images.sh

# éªŒè¯é•œåƒ
docker images | grep sec-agent
```

### 3. éƒ¨ç½²åˆ°Kubernetes

#### åˆ›å»ºå‘½åç©ºé—´
```bash
kubectl apply -f k8s/namespaces.yaml
```

#### åˆ›å»ºSecrets
```bash
# åˆ›å»ºAPIå¯†é’¥Secret
kubectl create secret generic sec-agent-secrets \
  --from-literal=DEEPSEEK_API_KEY=your-api-key-here \
  -n sec-agent-agents

# åˆ›å»ºæ•°æ®åº“Secret
kubectl create secret generic database-secrets \
  --from-literal=POSTGRES_USER=sec_agent \
  --from-literal=POSTGRES_PASSWORD=your-password \
  --from-literal=POSTGRES_DB=sec_agent \
  -n sec-agent-data
```

#### éƒ¨ç½²æ•°æ®å±‚
```bash
kubectl apply -f k8s/data-layer.yaml
```

#### éƒ¨ç½²åº”ç”¨å±‚
```bash
# éƒ¨ç½²MCPæœåŠ¡
kubectl apply -f k8s/mcp-services-deployment.yaml

# éƒ¨ç½²AIæ™ºèƒ½ä»£ç†
kubectl apply -f k8s/ai-agents-deployment.yaml

# éƒ¨ç½²åç«¯API
kubectl apply -f k8s/backend-deployment.yaml

# éƒ¨ç½²å‰ç«¯
kubectl apply -f k8s/frontend-deployment.yaml
```

#### é…ç½®Ingress
```bash
kubectl apply -f k8s/ingress.yaml
```

### 4. éªŒè¯éƒ¨ç½²

#### æ£€æŸ¥PodçŠ¶æ€
```bash
# æ£€æŸ¥æ‰€æœ‰å‘½åç©ºé—´çš„Pod
kubectl get pods --all-namespaces | grep sec-agent

# æ£€æŸ¥ç‰¹å®šå‘½åç©ºé—´
kubectl get pods -n sec-agent-frontend
kubectl get pods -n sec-agent-backend
kubectl get pods -n sec-agent-agents
kubectl get pods -n sec-agent-services
kubectl get pods -n sec-agent-data
```

#### æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥æœåŠ¡
kubectl get svc --all-namespaces | grep sec-agent

# æ£€æŸ¥Ingress
kubectl get ingress -n sec-agent-frontend
```

#### æŸ¥çœ‹æ—¥å¿—
```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
kubectl logs -f deployment/backend -n sec-agent-backend

# æŸ¥çœ‹åœºæ™¯æ™ºèƒ½ä½“æ—¥å¿—
kubectl logs -f deployment/scenario-agent -n sec-agent-agents
```

## ğŸ”§ è¿ç»´ç®¡ç†

### 1. æ‰©ç¼©å®¹ç®¡ç†

#### æ‰‹åŠ¨æ‰©ç¼©å®¹
```bash
# æ‰©å±•åç«¯å‰¯æœ¬æ•°
kubectl scale deployment backend --replicas=5 -n sec-agent-backend

# æ‰©å±•AIæ™ºèƒ½ä»£ç†
kubectl scale deployment scenario-agent --replicas=3 -n sec-agent-agents
```

#### è‡ªåŠ¨æ‰©ç¼©å®¹ (HPA)
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: sec-agent-backend
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 2. æ»šåŠ¨æ›´æ–°

```bash
# æ›´æ–°é•œåƒ
kubectl set image deployment/backend backend=your-registry.com/sec-agent/backend:v1.1.0 -n sec-agent-backend

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/backend -n sec-agent-backend

# å›æ»šæ›´æ–°
kubectl rollout undo deployment/backend -n sec-agent-backend
```

### 3. ç›‘æ§å’Œæ—¥å¿—

#### Prometheusç›‘æ§é…ç½®
```yaml
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: sec-agent-monitor
  namespace: sec-agent-backend
spec:
  selector:
    matchLabels:
      app: backend
  endpoints:
  - port: metrics
    path: /metrics
```

#### æ—¥å¿—æ”¶é›†é…ç½®
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: kube-system
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/sec-agent*.log
      pos_file /var/log/fluentd-sec-agent.log.pos
      tag kubernetes.sec-agent
      format json
    </source>

    <match kubernetes.sec-agent>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      index_name sec-agent
    </match>
```

## ğŸ” å®‰å…¨é…ç½®

### 1. ç½‘ç»œç­–ç•¥

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sec-agent-network-policy
  namespace: sec-agent-backend
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: sec-agent-frontend
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: sec-agent-data
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 6379
```

### 2. Podå®‰å…¨ç­–ç•¥

```yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: sec-agent-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

## ğŸ“‹ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Podå¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod <pod-name> -n <namespace>

# æŸ¥çœ‹äº‹ä»¶
kubectl get events -n <namespace> --sort-by='.lastTimestamp'
```

#### 2. æœåŠ¡æ— æ³•è®¿é—®
```bash
# æ£€æŸ¥æœåŠ¡ç«¯ç‚¹
kubectl get endpoints -n <namespace>

# æµ‹è¯•æœåŠ¡è¿é€šæ€§
kubectl run test-pod --image=busybox -it --rm -- /bin/sh
# åœ¨Podå†…æ‰§è¡Œ: wget -qO- http://service-name:port
```

#### 3. å­˜å‚¨é—®é¢˜
```bash
# æ£€æŸ¥PVå’ŒPVCçŠ¶æ€
kubectl get pv,pvc --all-namespaces

# æŸ¥çœ‹å­˜å‚¨ç±»
kubectl get storageclass
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### 1. èµ„æºé…ç½®ä¼˜åŒ–
- æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´CPUå’Œå†…å­˜é™åˆ¶
- ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§ä¼˜åŒ–Podè°ƒåº¦
- é…ç½®åˆé€‚çš„å‰¯æœ¬æ•°é‡

### 2. ç½‘ç»œä¼˜åŒ–
- ä½¿ç”¨Service Mesh (å¦‚Istio) ä¼˜åŒ–æœåŠ¡é—´é€šä¿¡
- é…ç½®åˆé€‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
- å¯ç”¨HTTP/2å’ŒgRPC

### 3. å­˜å‚¨ä¼˜åŒ–
- ä½¿ç”¨SSDå­˜å‚¨ç±»æå‡I/Oæ€§èƒ½
- é…ç½®æ•°æ®åº“è¿æ¥æ± 
- å®æ–½æ•°æ®åˆ†ç‰‡å’Œè¯»å†™åˆ†ç¦»

---

**ç‰ˆæœ¬**: v1.0.0
**æ›´æ–°æ—¥æœŸ**: 2024å¹´12æœˆ
**ç»´æŠ¤å›¢é˜Ÿ**: AI Agentæ”»é˜²æ¨æ¼”å¹³å°å¼€å‘å›¢é˜Ÿ

é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨å¯ä»¥åœ¨Kubernetesé›†ç¾¤ä¸­æˆåŠŸéƒ¨ç½²é«˜å¯ç”¨ã€å¯æ‰©å±•çš„AI Agentæ”»é˜²æ¨æ¼”å¹³å°ã€‚
```
```
```
