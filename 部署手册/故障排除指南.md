# 故障排除指南

本文档提供常见问题的诊断和解决方案，帮助您快速解决部署和运行过程中遇到的问题。

## 🔍 问题诊断流程

### 1. 基础检查
```bash
# 检查系统资源
df -h          # 磁盘空间
free -h        # 内存使用
top            # CPU使用

# 检查网络连接
ping google.com
curl -I http://localhost:8080
```

### 2. 服务状态检查
```bash
# 检查端口占用
netstat -tulpn | grep :8080  # Linux
netstat -ano | findstr :8080 # Windows

# 检查进程状态
ps aux | grep python  # Linux
tasklist | findstr python  # Windows
```

## ❌ 常见错误及解决方案

### 1. 依赖安装问题

#### 错误: npm install 失败
```
npm ERR! network request failed
npm ERR! network This is a problem related to network connectivity
```

**解决方案:**
```bash
# 方案1: 清除npm缓存
npm cache clean --force
rm -rf node_modules package-lock.json
npm install

# 方案2: 使用国内镜像源
npm config set registry https://registry.npmmirror.com/
npm install

# 方案3: 使用yarn替代
npm install -g yarn
yarn install
```

#### 错误: pip install 失败
```
ERROR: Could not install packages due to an EnvironmentError
```

**解决方案:**
```bash
# 方案1: 升级pip
python -m pip install --upgrade pip

# 方案2: 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/

# 方案3: 使用虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows
pip install -r requirements.txt
```

### 2. 端口占用问题

#### 错误: 端口已被占用
```
Error: listen EADDRINUSE: address already in use :::8080
```

**解决方案:**
```bash
# 查找占用端口的进程
# Linux/macOS
lsof -i :8080
netstat -tulpn | grep :8080

# Windows
netstat -ano | findstr :8080

# 终止进程
kill -9 <PID>        # Linux/macOS
taskkill /PID <PID> /F  # Windows

# 或者修改配置使用其他端口
# 在 backend/.env 中设置: PORT=8081
```

### 3. API密钥问题

#### 错误: DeepSeek API调用失败
```
Error: Invalid API key provided
```

**解决方案:**
1. 检查API密钥是否正确配置
```bash
cat agents/scenario_agent/.env
```

2. 验证API密钥格式
```env
# 正确格式
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 错误格式 (缺少sk-前缀)
DEEPSEEK_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

3. 测试API连接
```bash
curl -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"Hello"}]}' \
     https://api.deepseek.com/v1/chat/completions
```

### 4. Docker相关问题

#### 错误: Docker daemon未运行
```
Cannot connect to the Docker daemon at unix:///var/run/docker.sock
```

**解决方案:**
```bash
# Linux
sudo systemctl start docker
sudo systemctl enable docker

# Windows/macOS
# 启动Docker Desktop应用程序

# 验证Docker状态
docker info
```

#### 错误: Docker镜像构建失败
```
ERROR: failed to solve: process "/bin/sh -c apt-get update" did not complete successfully
```

**解决方案:**
```bash
# 清理Docker缓存
docker system prune -a

# 重新构建镜像
docker build --no-cache -t sec-agent/ubuntu ./docker/images/ubuntu

# 检查Dockerfile语法
docker build --dry-run -t test ./docker/images/ubuntu
```

### 5. 前端构建问题

#### 错误: Vite构建失败
```
Error: Build failed with 1 error:
node_modules/some-package/index.js:1:0: ERROR: Top-level await is not available
```

**解决方案:**
```bash
# 更新Node.js版本 (需要16+)
node --version

# 清除缓存重新安装
rm -rf node_modules package-lock.json
npm install

# 检查vite.config.js配置
npm run build -- --debug
```

### 6. 后端服务问题

#### 错误: FastAPI启动失败
```
ImportError: No module named 'fastapi'
```

**解决方案:**
```bash
# 检查Python环境
which python
python --version

# 重新安装依赖
cd backend
pip install -r requirements.txt

# 检查虚拟环境
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 错误: 数据库连接失败
```
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) unable to open database file
```

**解决方案:**
```bash
# 检查数据库文件权限
ls -la app.db

# 创建数据库目录
mkdir -p data
chmod 755 data

# 检查数据库URL配置
echo $DATABASE_URL
```

## 🔧 性能问题诊断

### 1. 内存使用过高

**诊断:**
```bash
# 检查内存使用
free -h
ps aux --sort=-%mem | head

# 检查Python进程内存
ps -p <PID> -o pid,vsz,rss,comm
```

**解决方案:**
```bash
# 限制Python内存使用
export PYTHONMALLOC=malloc
ulimit -v 2097152  # 限制为2GB

# 优化代码
# 在agents配置中减少MAX_TOKENS
MAX_TOKENS=2000
```

### 2. CPU使用过高

**诊断:**
```bash
# 检查CPU使用
top -p <PID>
htop

# 检查进程线程
ps -T -p <PID>
```

**解决方案:**
```bash
# 限制并发请求
# 在backend/.env中设置
RATE_LIMIT=50
MAX_WORKERS=4
```

### 3. 网络延迟问题

**诊断:**
```bash
# 测试API响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:8080/health

# 创建curl-format.txt
echo "time_total: %{time_total}\ntime_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}" > curl-format.txt
```

**解决方案:**
```bash
# 优化API超时设置
TIMEOUT=10
MAX_RETRIES=2

# 启用连接池
KEEP_ALIVE=True
CONNECTION_POOL_SIZE=20
```

## 📋 日志分析

### 1. 查看服务日志

```bash
# 后端服务日志
tail -f backend/logs/app.log

# 场景智能体日志
tail -f agents/scenario_agent/logs/agent.log

# 系统日志
journalctl -u docker  # Linux
```

### 2. 常见日志错误

#### 连接超时
```
TimeoutError: Request timeout after 30 seconds
```
**解决:** 增加TIMEOUT配置值

#### API配额超限
```
RateLimitError: Rate limit exceeded
```
**解决:** 检查API使用量，考虑升级套餐

#### 内存不足
```
MemoryError: Unable to allocate memory
```
**解决:** 增加系统内存或优化代码

## 🛠️ 调试工具

### 1. 健康检查脚本

创建 `debug_health.py`:
```python
#!/usr/bin/env python3
import requests
import sys

def check_service(name, url):
    try:
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            print(f"✅ {name}: OK")
            return True
        else:
            print(f"❌ {name}: HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"❌ {name}: {e}")
        return False

services = [
    ("前端", "http://localhost:5173"),
    ("后端", "http://localhost:8080/health"),
    ("场景服务", "http://localhost:8002/health"),
    ("场景智能体", "http://localhost:8007/health"),
]

all_ok = True
for name, url in services:
    if not check_service(name, url):
        all_ok = False

sys.exit(0 if all_ok else 1)
```

### 2. 环境检查脚本

创建 `debug_env.py`:
```python
#!/usr/bin/env python3
import os
import sys
from pathlib import Path

def check_file(path, required=True):
    if Path(path).exists():
        print(f"✅ {path}: 存在")
        return True
    else:
        status = "❌" if required else "⚠️"
        print(f"{status} {path}: 不存在")
        return not required

def check_env_var(var, required=True):
    value = os.getenv(var)
    if value:
        print(f"✅ {var}: 已设置")
        return True
    else:
        status = "❌" if required else "⚠️"
        print(f"{status} {var}: 未设置")
        return not required

# 检查必需文件
files_ok = all([
    check_file("package.json"),
    check_file("backend/requirements.txt"),
    check_file("agents/scenario_agent/.env"),
])

# 检查环境变量
os.chdir("agents/scenario_agent")
from dotenv import load_dotenv
load_dotenv()

env_ok = all([
    check_env_var("DEEPSEEK_API_KEY"),
    check_env_var("DEEPSEEK_BASE_URL"),
    check_env_var("MODEL_NAME"),
])

if files_ok and env_ok:
    print("\n🎉 环境检查通过!")
    sys.exit(0)
else:
    print("\n❌ 环境检查失败，请修复上述问题")
    sys.exit(1)
```

## 📞 获取帮助

### 1. 收集诊断信息

运行以下命令收集系统信息：
```bash
# 创建诊断报告
cat > diagnostic_info.txt << EOF
=== 系统信息 ===
操作系统: $(uname -a)
Python版本: $(python --version)
Node.js版本: $(node --version)
Docker版本: $(docker --version)

=== 磁盘空间 ===
$(df -h)

=== 内存使用 ===
$(free -h)

=== 端口占用 ===
$(netstat -tulpn | grep -E ':(5173|8080|8002|8007)')

=== 进程状态 ===
$(ps aux | grep -E '(python|node|npm)')
EOF
```

### 2. 联系技术支持

提供以下信息以获得更好的技术支持：
- 操作系统版本
- 错误日志内容
- 部署步骤记录
- 系统配置信息
- 诊断报告文件

### 3. 社区资源

- 项目文档: 查看项目README和文档
- 问题追踪: 在项目仓库提交Issue
- 讨论论坛: 参与技术讨论

记住：大多数问题都有解决方案，保持耐心并系统性地排查问题！
