# 生产环境部署指南

本文档提供在生产环境中部署AI Agent攻防推演平台的详细指南，包括安全配置、性能优化和监控设置。

## 🏗️ 生产环境架构

### 推荐架构图
```
Internet
    ↓
[Load Balancer/CDN]
    ↓
[Reverse Proxy (Nginx)]
    ↓
[Frontend (Static Files)]
    ↓
[Backend API Gateway]
    ↓
[Microservices Cluster]
    ├── Scenario Service
    ├── Attack Service  
    ├── Defense Service
    ├── Evaluate Service
    └── AI Agents
    ↓
[Database Cluster]
[Redis Cache]
[Log Aggregation]
```

## 🔧 环境准备

### 1. 服务器要求

#### 最小配置
- **CPU**: 8核心
- **内存**: 16GB
- **存储**: 100GB SSD
- **网络**: 100Mbps带宽

#### 推荐配置
- **CPU**: 16核心
- **内存**: 32GB
- **存储**: 500GB SSD
- **网络**: 1Gbps带宽

### 2. 操作系统配置

```bash
# Ubuntu 20.04/22.04 推荐配置
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y \
    docker.io \
    docker-compose \
    nginx \
    certbot \
    python3-certbot-nginx \
    htop \
    iotop \
    netstat-nat

# 配置防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
```

## 🐳 Docker生产部署

### 1. 创建生产环境Docker Compose

创建 `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: sec_agent_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./dist:/usr/share/nginx/html
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - frontend_net

  # 前端构建
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: sec_agent_frontend
    volumes:
      - ./dist:/app/dist
    command: npm run build
    networks:
      - frontend_net

  # 后端API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sec_agent_backend
    environment:
      - DEBUG=False
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://sec_agent:${DB_PASSWORD}@postgres:5432/sec_agent
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - frontend_net
      - backend_net

  # 场景服务
  scenario_service:
    build:
      context: ./services/scenario_service
      dockerfile: Dockerfile
    container_name: sec_agent_scenario
    environment:
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - backend_net

  # 场景智能体
  scenario_agent:
    build:
      context: ./agents/scenario_agent
      dockerfile: Dockerfile
    container_name: sec_agent_ai
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - backend_net

  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: sec_agent_db
    environment:
      - POSTGRES_DB=sec_agent
      - POSTGRES_USER=sec_agent
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    restart: unless-stopped
    networks:
      - backend_net

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: sec_agent_redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - backend_net

  # 日志收集
  fluentd:
    image: fluent/fluentd:v1.16-1
    container_name: sec_agent_logs
    volumes:
      - ./logs:/fluentd/log
      - ./fluentd/conf:/fluentd/etc
    restart: unless-stopped
    networks:
      - backend_net

volumes:
  postgres_data:
  redis_data:

networks:
  frontend_net:
    driver: bridge
  backend_net:
    driver: bridge
```

### 2. 环境变量配置

创建 `.env.prod`:

```env
# 数据库密码
DB_PASSWORD=your_secure_db_password_here

# Redis密码
REDIS_PASSWORD=your_secure_redis_password_here

# DeepSeek API密钥
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# JWT密钥
JWT_SECRET=your_very_secure_jwt_secret_here

# 域名配置
DOMAIN=yourdomain.com
```

## 🌐 Nginx配置

### 1. 主配置文件

创建 `nginx/nginx.conf`:

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # 上游服务器
    upstream backend {
        server backend:8080;
        keepalive 32;
    }

    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name yourdomain.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS主站
    server {
        listen 443 ssl http2;
        server_name yourdomain.com;

        # SSL配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        ssl_prefer_server_ciphers off;

        # 前端静态文件
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
            
            # 缓存静态资源
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # API代理
        location /api/ {
            proxy_pass http://backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # WebSocket代理
        location /ws {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

## 🔒 SSL证书配置

### 1. 使用Let's Encrypt

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d yourdomain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. 手动SSL证书

```bash
# 创建SSL目录
mkdir -p nginx/ssl

# 复制证书文件
cp your_cert.pem nginx/ssl/cert.pem
cp your_key.pem nginx/ssl/key.pem

# 设置权限
chmod 600 nginx/ssl/key.pem
chmod 644 nginx/ssl/cert.pem
```

## 📊 监控和日志

### 1. 系统监控

安装Prometheus和Grafana:

```yaml
# 添加到docker-compose.prod.yml
  prometheus:
    image: prom/prometheus:latest
    container_name: sec_agent_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: sec_agent_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped
```

### 2. 日志聚合

配置Fluentd收集日志:

```ruby
# fluentd/conf/fluent.conf
<source>
  @type tail
  path /fluentd/log/*.log
  pos_file /fluentd/log/fluentd.log.pos
  tag sec_agent.*
  format json
</source>

<match sec_agent.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name sec_agent
</match>
```

## 🚀 部署流程

### 1. 准备部署

```bash
# 克隆代码
git clone <repository_url>
cd sec_agent

# 创建必要目录
mkdir -p logs uploads backups nginx/ssl

# 设置环境变量
cp .env.example .env.prod
# 编辑 .env.prod 文件
```

### 2. 构建和启动

```bash
# 构建前端
npm install
npm run build

# 启动生产环境
docker-compose -f docker-compose.prod.yml up -d

# 检查服务状态
docker-compose -f docker-compose.prod.yml ps
```

### 3. 验证部署

```bash
# 检查服务健康状态
curl https://yourdomain.com/health
curl https://yourdomain.com/api/health

# 检查SSL证书
openssl s_client -connect yourdomain.com:443 -servername yourdomain.com
```

## 🔧 性能优化

### 1. 数据库优化

```sql
-- PostgreSQL优化配置
-- 在postgresql.conf中设置
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
```

### 2. Redis优化

```conf
# redis.conf优化配置
maxmemory 512mb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

### 3. 应用优化

```env
# backend/.env.prod
WORKERS=4
MAX_CONNECTIONS=100
POOL_SIZE=20
CACHE_TTL=3600
```

## 🔐 安全加固

### 1. 系统安全

```bash
# 禁用root登录
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# 配置fail2ban
sudo apt install fail2ban
sudo systemctl enable fail2ban

# 定期安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades
```

### 2. 应用安全

```env
# 安全配置
SECURE_COOKIES=True
CSRF_PROTECTION=True
RATE_LIMITING=True
API_KEY_ROTATION=True
```

## 📋 维护检查清单

### 日常维护
- [ ] 检查服务状态
- [ ] 监控系统资源使用
- [ ] 查看错误日志
- [ ] 验证备份完整性

### 周期维护
- [ ] 更新系统补丁
- [ ] 轮换API密钥
- [ ] 清理旧日志文件
- [ ] 性能调优分析

### 应急响应
- [ ] 备份恢复测试
- [ ] 故障转移演练
- [ ] 安全事件响应
- [ ] 容量扩展计划

生产环境部署需要仔细规划和测试，建议先在测试环境中验证所有配置后再部署到生产环境。
