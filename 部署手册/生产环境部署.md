# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²AI Agentæ”»é˜²æ¨æ¼”å¹³å°çš„è¯¦ç»†æŒ‡å—ï¼ŒåŒ…æ‹¬å®‰å…¨é…ç½®ã€æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§è®¾ç½®ã€‚

## ğŸ—ï¸ ç”Ÿäº§ç¯å¢ƒæ¶æ„

### æ¨èæ¶æ„å›¾
```
Internet
    â†“
[Load Balancer/CDN]
    â†“
[Reverse Proxy (Nginx)]
    â†“
[Frontend (Static Files)]
    â†“
[Backend API Gateway]
    â†“
[Microservices Cluster]
    â”œâ”€â”€ Scenario Service
    â”œâ”€â”€ Attack Service  
    â”œâ”€â”€ Defense Service
    â”œâ”€â”€ Evaluate Service
    â””â”€â”€ AI Agents
    â†“
[Database Cluster]
[Redis Cache]
[Log Aggregation]
```

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

#### æœ€å°é…ç½®
- **CPU**: 8æ ¸å¿ƒ
- **å†…å­˜**: 16GB
- **å­˜å‚¨**: 100GB SSD
- **ç½‘ç»œ**: 100Mbpså¸¦å®½

#### æ¨èé…ç½®
- **CPU**: 16æ ¸å¿ƒ
- **å†…å­˜**: 32GB
- **å­˜å‚¨**: 500GB SSD
- **ç½‘ç»œ**: 1Gbpså¸¦å®½

### 2. æ“ä½œç³»ç»Ÿé…ç½®

```bash
# Ubuntu 20.04/22.04 æ¨èé…ç½®
sudo apt update && sudo apt upgrade -y

# å®‰è£…å¿…è¦è½¯ä»¶
sudo apt install -y \
    docker.io \
    docker-compose \
    nginx \
    certbot \
    python3-certbot-nginx \
    htop \
    iotop \
    netstat-nat

# é…ç½®é˜²ç«å¢™
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
```

## ğŸ³ Dockerç”Ÿäº§éƒ¨ç½²

### 1. åˆ›å»ºç”Ÿäº§ç¯å¢ƒDocker Compose

åˆ›å»º `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: sec_agent_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./dist:/usr/share/nginx/html
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - frontend_net

  # å‰ç«¯æ„å»º
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: sec_agent_frontend
    volumes:
      - ./dist:/app/dist
    command: npm run build
    networks:
      - frontend_net

  # åç«¯API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sec_agent_backend
    environment:
      - DEBUG=False
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://sec_agent:${DB_PASSWORD}@postgres:5432/sec_agent
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - frontend_net
      - backend_net

  # åœºæ™¯æœåŠ¡
  scenario_service:
    build:
      context: ./services/scenario_service
      dockerfile: Dockerfile
    container_name: sec_agent_scenario
    environment:
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - backend_net

  # åœºæ™¯æ™ºèƒ½ä½“
  scenario_agent:
    build:
      context: ./agents/scenario_agent
      dockerfile: Dockerfile
    container_name: sec_agent_ai
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - backend_net

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: sec_agent_db
    environment:
      - POSTGRES_DB=sec_agent
      - POSTGRES_USER=sec_agent
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    restart: unless-stopped
    networks:
      - backend_net

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: sec_agent_redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - backend_net

  # æ—¥å¿—æ”¶é›†
  fluentd:
    image: fluent/fluentd:v1.16-1
    container_name: sec_agent_logs
    volumes:
      - ./logs:/fluentd/log
      - ./fluentd/conf:/fluentd/etc
    restart: unless-stopped
    networks:
      - backend_net

volumes:
  postgres_data:
  redis_data:

networks:
  frontend_net:
    driver: bridge
  backend_net:
    driver: bridge
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env.prod`:

```env
# æ•°æ®åº“å¯†ç 
DB_PASSWORD=your_secure_db_password_here

# Rediså¯†ç 
REDIS_PASSWORD=your_secure_redis_password_here

# DeepSeek APIå¯†é’¥
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# JWTå¯†é’¥
JWT_SECRET=your_very_secure_jwt_secret_here

# åŸŸåé…ç½®
DOMAIN=yourdomain.com
```

## ğŸŒ Nginxé…ç½®

### 1. ä¸»é…ç½®æ–‡ä»¶

åˆ›å»º `nginx/nginx.conf`:

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # å®‰å…¨å¤´
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # ä¸Šæ¸¸æœåŠ¡å™¨
    upstream backend {
        server backend:8080;
        keepalive 32;
    }

    # HTTPé‡å®šå‘åˆ°HTTPS
    server {
        listen 80;
        server_name yourdomain.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPSä¸»ç«™
    server {
        listen 443 ssl http2;
        server_name yourdomain.com;

        # SSLé…ç½®
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        ssl_prefer_server_ciphers off;

        # å‰ç«¯é™æ€æ–‡ä»¶
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
            
            # ç¼“å­˜é™æ€èµ„æº
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # WebSocketä»£ç†
        location /ws {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

## ğŸ”’ SSLè¯ä¹¦é…ç½®

### 1. ä½¿ç”¨Let's Encrypt

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d yourdomain.com

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. æ‰‹åŠ¨SSLè¯ä¹¦

```bash
# åˆ›å»ºSSLç›®å½•
mkdir -p nginx/ssl

# å¤åˆ¶è¯ä¹¦æ–‡ä»¶
cp your_cert.pem nginx/ssl/cert.pem
cp your_key.pem nginx/ssl/key.pem

# è®¾ç½®æƒé™
chmod 600 nginx/ssl/key.pem
chmod 644 nginx/ssl/cert.pem
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. ç³»ç»Ÿç›‘æ§

å®‰è£…Prometheuså’ŒGrafana:

```yaml
# æ·»åŠ åˆ°docker-compose.prod.yml
  prometheus:
    image: prom/prometheus:latest
    container_name: sec_agent_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: sec_agent_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped
```

### 2. æ—¥å¿—èšåˆ

é…ç½®Fluentdæ”¶é›†æ—¥å¿—:

```ruby
# fluentd/conf/fluent.conf
<source>
  @type tail
  path /fluentd/log/*.log
  pos_file /fluentd/log/fluentd.log.pos
  tag sec_agent.*
  format json
</source>

<match sec_agent.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name sec_agent
</match>
```

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. å‡†å¤‡éƒ¨ç½²

```bash
# å…‹éš†ä»£ç 
git clone <repository_url>
cd sec_agent

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p logs uploads backups nginx/ssl

# è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.prod
# ç¼–è¾‘ .env.prod æ–‡ä»¶
```

### 2. æ„å»ºå’Œå¯åŠ¨

```bash
# æ„å»ºå‰ç«¯
npm install
npm run build

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker-compose.prod.yml up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl https://yourdomain.com/health
curl https://yourdomain.com/api/health

# æ£€æŸ¥SSLè¯ä¹¦
openssl s_client -connect yourdomain.com:443 -servername yourdomain.com
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- PostgreSQLä¼˜åŒ–é…ç½®
-- åœ¨postgresql.confä¸­è®¾ç½®
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
```

### 2. Redisä¼˜åŒ–

```conf
# redis.confä¼˜åŒ–é…ç½®
maxmemory 512mb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

### 3. åº”ç”¨ä¼˜åŒ–

```env
# backend/.env.prod
WORKERS=4
MAX_CONNECTIONS=100
POOL_SIZE=20
CACHE_TTL=3600
```

## ğŸ” å®‰å…¨åŠ å›º

### 1. ç³»ç»Ÿå®‰å…¨

```bash
# ç¦ç”¨rootç™»å½•
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# é…ç½®fail2ban
sudo apt install fail2ban
sudo systemctl enable fail2ban

# å®šæœŸå®‰å…¨æ›´æ–°
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades
```

### 2. åº”ç”¨å®‰å…¨

```env
# å®‰å…¨é…ç½®
SECURE_COOKIES=True
CSRF_PROTECTION=True
RATE_LIMITING=True
API_KEY_ROTATION=True
```

## ğŸ“‹ ç»´æŠ¤æ£€æŸ¥æ¸…å•

### æ—¥å¸¸ç»´æŠ¤
- [ ] æ£€æŸ¥æœåŠ¡çŠ¶æ€
- [ ] ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
- [ ] æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§

### å‘¨æœŸç»´æŠ¤
- [ ] æ›´æ–°ç³»ç»Ÿè¡¥ä¸
- [ ] è½®æ¢APIå¯†é’¥
- [ ] æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶
- [ ] æ€§èƒ½è°ƒä¼˜åˆ†æ

### åº”æ€¥å“åº”
- [ ] å¤‡ä»½æ¢å¤æµ‹è¯•
- [ ] æ•…éšœè½¬ç§»æ¼”ç»ƒ
- [ ] å®‰å…¨äº‹ä»¶å“åº”
- [ ] å®¹é‡æ‰©å±•è®¡åˆ’

ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦ä»”ç»†è§„åˆ’å’Œæµ‹è¯•ï¼Œå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯æ‰€æœ‰é…ç½®åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚
