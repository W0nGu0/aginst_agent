# 手动部署指南

本文档提供详细的手动部署步骤，适用于需要自定义配置或自动化脚本无法满足需求的情况。

## 📋 部署前准备

### 1. 系统要求检查

#### 硬件要求
- CPU: 4核心以上 (推荐8核心)
- 内存: 8GB以上 (推荐16GB)
- 存储: 50GB以上可用空间
- 网络: 稳定的互联网连接

#### 软件要求
- 操作系统: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- Docker: 20.10+
- Docker Compose: 2.0+
- Node.js: 18.0+ (LTS版本)
- Python: 3.9+
- Git: 2.30+

### 2. 环境验证

```bash
# 检查Docker
docker --version
docker-compose --version

# 检查Node.js和NPM
node --version
npm --version

# 检查Python
python --version  # Windows
python3 --version # Linux/macOS

# 检查pip
pip --version   # Windows
pip3 --version  # Linux/macOS
```

## 🚀 详细部署步骤

### 步骤1: 获取项目代码

```bash
# 克隆项目 (如果还未获取)
git clone <项目仓库地址>
cd sec_agent

# 或者解压项目压缩包
unzip sec_agent.zip
cd sec_agent
```

### 步骤2: 安装前端依赖

```bash
# 安装Node.js依赖
npm install

# 如果安装失败，尝试清除缓存
npm cache clean --force
rm -rf node_modules package-lock.json  # Linux/macOS
# 或者在Windows中删除node_modules文件夹和package-lock.json文件
npm install
```

### 步骤3: 安装Python依赖

#### 3.1 安装全局Python依赖

```bash
# Linux/macOS
pip3 install -r requirements.txt

# Windows
pip install -r requirements.txt

# 如果安装失败，使用国内镜像源
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

#### 3.2 安装后端依赖

```bash
cd backend

# Linux/macOS
pip3 install -r requirements.txt

# Windows
pip install -r requirements.txt

cd ..
```

### 步骤4: 配置环境变量

#### 4.1 创建AI Agent配置文件

创建文件 `agents/scenario_agent/.env`:

```env
# DeepSeek API配置 (必需)
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com
MODEL_NAME=deepseek-chat

# 可选配置
MAX_TOKENS=4000
TEMPERATURE=0.7
TIMEOUT=30
```

#### 4.2 创建后端配置文件 (可选)

创建文件 `backend/.env`:

```env
# 调试模式
DEBUG=True
LOG_LEVEL=INFO

# CORS配置
CORS_ORIGINS=http://localhost:5173,http://localhost:3000,http://127.0.0.1:5173

# 数据库配置 (如果使用)
DATABASE_URL=sqlite:///./app.db

# 安全配置
SECRET_KEY=your-secret-key-here
```

#### 4.3 创建Docker环境配置 (可选)

创建文件 `docker/.env`:

```env
# MySQL配置
MYSQL_ROOT_PASSWORD=rootpass
MYSQL_DATABASE=testdb
MYSQL_USER=testuser
MYSQL_PASSWORD=testpass

# 公司信息
COMPANY=ACME_CORP
```

### 步骤5: 构建Docker镜像 (可选)

如果需要使用Docker容器化的靶场环境：

```bash
# 进入Docker镜像目录
cd docker/images

# 构建基础镜像
docker build -t sec-agent/ubuntu ./ubuntu
docker build -t sec-agent/centos ./centos
docker build -t sec-agent/debian ./debian

# 构建其他专用镜像
docker build -t sec-agent/healthcare ./healthcare
docker build -t sec-agent/apt-targets ./apt-targets

cd ../..
```

### 步骤6: 启动服务

#### 6.1 方式一：使用启动脚本 (推荐)

```bash
# Linux/macOS
python3 start_all_services.py

# Windows
python start_all_services.py
```

#### 6.2 方式二：手动启动各个服务

**终端1 - 启动场景服务:**
```bash
cd services/scenario_service
python3 main.py  # Linux/macOS
python main.py   # Windows
```

**终端2 - 启动场景智能体:**
```bash
cd agents/scenario_agent
python3 main.py  # Linux/macOS
python main.py   # Windows
```

**终端3 - 启动后端服务:**
```bash
cd backend
python3 main.py  # Linux/macOS
python main.py   # Windows
```

**终端4 - 启动前端开发服务器:**
```bash
npm run dev
```

### 步骤7: 验证部署

#### 7.1 检查服务状态

访问以下地址确认服务正常运行：

- 前端界面: http://localhost:5173
- 后端API文档: http://localhost:8080/docs
- 场景服务: http://localhost:8002
- 场景智能体: http://localhost:8007

#### 7.2 运行测试脚本

```bash
# 测试前端和后端连接
python3 test_phase2_frontend.py

# 测试场景智能体健康状态
python3 test_scenario_agent_health.py

# 测试后端到智能体的连接
python3 test_backend_to_agent.py
```

## 🔧 高级配置

### 自定义端口配置

如果默认端口被占用，可以修改以下配置：

#### 前端端口 (vite.config.js)
```javascript
export default defineConfig({
  server: {
    port: 3000, // 修改为其他端口
    // ...
  }
})
```

#### 后端端口 (backend/main.py)
```python
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8081)  # 修改端口
```

### 数据库配置

如果需要使用外部数据库：

```env
# PostgreSQL
DATABASE_URL=postgresql://user:password@localhost:5432/dbname

# MySQL
DATABASE_URL=mysql://user:password@localhost:3306/dbname

# SQLite (默认)
DATABASE_URL=sqlite:///./app.db
```

### 日志配置

修改日志级别和输出位置：

```python
# backend/main.py
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

## 🐳 Docker Compose部署

对于生产环境，推荐使用Docker Compose：

### 1. 创建docker-compose.yml

```yaml
version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DEBUG=False
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs

  scenario_service:
    build:
      context: ./services/scenario_service
      dockerfile: Dockerfile
    ports:
      - "8002:8002"

  scenario_agent:
    build:
      context: ./agents/scenario_agent
      dockerfile: Dockerfile
    ports:
      - "8007:8007"
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
```

### 2. 启动Docker Compose

```bash
# 构建并启动所有服务
docker-compose up --build

# 后台运行
docker-compose up -d

# 停止服务
docker-compose down
```

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 端口被占用
```bash
# 查看端口占用情况
netstat -tulpn | grep :8080  # Linux
netstat -ano | findstr :8080 # Windows

# 杀死占用端口的进程
kill -9 <PID>  # Linux
taskkill /PID <PID> /F  # Windows
```

#### 2. Python依赖安装失败
```bash
# 升级pip
pip install --upgrade pip

# 使用虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows

# 重新安装依赖
pip install -r requirements.txt
```

#### 3. Node.js依赖安装失败
```bash
# 清除npm缓存
npm cache clean --force

# 删除node_modules重新安装
rm -rf node_modules package-lock.json
npm install

# 使用yarn替代npm
npm install -g yarn
yarn install
```

#### 4. Docker相关问题
```bash
# 检查Docker状态
docker info

# 重启Docker服务
sudo systemctl restart docker  # Linux
# 或重启Docker Desktop (Windows/macOS)

# 清理Docker缓存
docker system prune -a
```

## 📝 部署检查清单

- [ ] 系统要求满足
- [ ] 所有依赖软件已安装
- [ ] 项目代码已获取
- [ ] 前端依赖安装成功
- [ ] Python依赖安装成功
- [ ] 环境配置文件已创建
- [ ] DeepSeek API密钥已配置
- [ ] 所有服务启动成功
- [ ] 网页界面可正常访问
- [ ] 测试脚本运行通过

完成以上检查清单后，您的AI Agent攻防推演平台就部署成功了！
